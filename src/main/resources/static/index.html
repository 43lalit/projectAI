<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDRM Console</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/mdrm-console.css">
</head>
<body class="bg-body-tertiary">
  <main class="shell container-fluid">
    <section class="panel hero">
      <h1>Fed Micro Data Reference Management Discovery Tool</h1>
    </section>

    <nav class="panel menu" aria-label="MDRM Menu">
      <a id="menu-load" class="menu-link active" data-view="view-load" href="#">Load MDRM</a>
      <a id="menu-reporting" class="menu-link" data-view="view-reporting" href="#">Reporting Viewer</a>
      <a id="menu-mdrm-page" class="menu-link" href="/mdrm.html">MDRM Page</a>
    </nav>

    <section id="view-load" class="panel view active">
      <div class="row mt-3 g-2 align-items-center">
        <div class="col-md-6 col-lg-7">
          <input id="uploadFileInput" class="form-control" type="file" accept=".csv">
        </div>
        <div class="col-auto">
          <button id="uploadFileBtn" class="btn btn-outline-primary" type="button">Upload</button>
        </div>
        <div class="col-auto">
          <button id="runLoadBtn" class="primary btn btn-primary" type="button" disabled>Run Load</button>
        </div>
      </div>
      <div id="loadStatus" class="status neutral">Ready.</div>
      <div id="fileMetricsContainer" class="table-shell mt-3"></div>
      <div id="fileIncrementalTitle" class="status neutral mt-2">Select a run to view incremental changes by report.</div>
      <div class="row g-3 flex-nowrap">
        <div class="col-7">
          <div id="fileIncrementalContainer" class="table-shell"></div>
        </div>
        <div class="col-5">
          <div id="fileIncrementalDetailPanel" class="table-shell"></div>
        </div>
      </div>
    </section>

    <section id="view-reporting" class="panel view">
      <div class="reporting-layout">
        <aside class="report-list-pane">
          <select id="leftNavMode" class="form-select form-select-sm">
            <option value="reports">Reports (0)</option>
            <option value="mdrms">MDRMs</option>
          </select>
          <input id="reportSearchInput" class="form-control" type="text" placeholder="Search reports...">
          <div id="reportListContainer" class="report-list"></div>
        </aside>

        <section class="report-main-pane">
          <div class="report-header">
            <div id="selectedReportLabel" class="selected-report">Selected Report: -</div>
            <div class="tab-row" role="tablist" aria-label="Report views">
              <a id="tabSummaryBtn" class="tab-link active" href="#" data-tab="summaryTab" role="tab" aria-selected="true">Run Summary</a>
              <a id="tabDetailsBtn" class="tab-link" href="#" data-tab="detailsTab" role="tab" aria-selected="false">Regular Details</a>
            </div>
          </div>

          <section id="summaryTab" class="tab-panel active" role="tabpanel" aria-labelledby="tabSummaryBtn">
            <div id="summaryTableContainer" class="table-shell"></div>
            <div id="drilldownTitle" class="status neutral">Select a count to view MDRM codes.</div>
            <div id="drilldownTableContainer" class="table-shell"></div>
          </section>

          <section id="detailsTab" class="tab-panel" role="tabpanel" aria-labelledby="tabDetailsBtn">
            <div id="tableContainer" class="table-shell"></div>
          </section>
        </section>
      </div>
    </section>
  </main>

  <script>
    const menuButtons = Array.from(document.querySelectorAll('.menu-link'));
    const views = Array.from(document.querySelectorAll('.view'));
    let formsLoaded = false;
    let allForms = [];
    let selectedReportingForm = '';

    function switchView(targetViewId) {
      views.forEach(view => view.classList.toggle('active', view.id === targetViewId));
      menuButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === targetViewId));
      if (targetViewId === 'view-reporting' && !formsLoaded) {
        refreshForms();
      }
    }

    menuButtons.forEach(button => {
      button.addEventListener('click', event => {
        if (!button.dataset.view) {
          return;
        }
        event.preventDefault();
        switchView(button.dataset.view);
      });
    });

    const runLoadBtn = document.getElementById('runLoadBtn');
    const uploadFileInput = document.getElementById('uploadFileInput');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const loadStatus = document.getElementById('loadStatus');
    const fileMetricsContainer = document.getElementById('fileMetricsContainer');
    const fileIncrementalTitle = document.getElementById('fileIncrementalTitle');
    const fileIncrementalContainer = document.getElementById('fileIncrementalContainer');
    const fileIncrementalDetailPanel = document.getElementById('fileIncrementalDetailPanel');
    const leftNavMode = document.getElementById('leftNavMode');
    const reportSearchInput = document.getElementById('reportSearchInput');
    const reportListContainer = document.getElementById('reportListContainer');
    const selectedReportLabel = document.getElementById('selectedReportLabel');
    const tableContainer = document.getElementById('tableContainer');
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    const drilldownTitle = document.getElementById('drilldownTitle');
    const drilldownTableContainer = document.getElementById('drilldownTableContainer');
    const tabButtons = Array.from(document.querySelectorAll('.tab-link'));
    const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));

    function hasSelectedUploadFile() {
      return !!(uploadFileInput.files && uploadFileInput.files.length > 0);
    }

    function updateLoadButtonStates() {
      runLoadBtn.disabled = !hasSelectedUploadFile();
    }

    function setLoadStatus(text, css) {
      loadStatus.textContent = text;
      loadStatus.className = `status ${css}`;
    }

    function setLoadActionsDisabled(disabled) {
      runLoadBtn.disabled = disabled || !hasSelectedUploadFile();
      uploadFileBtn.disabled = disabled;
      uploadFileInput.disabled = disabled;
    }

    function setReportingBusy(isBusy) {
      reportSearchInput.disabled = isBusy;
      leftNavMode.disabled = isBusy;
      reportListContainer.classList.toggle('busy', isBusy);
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function clearReportData() {
      summaryTableContainer.innerHTML = '';
      drilldownTitle.textContent = 'Select a count to view MDRM codes.';
      drilldownTitle.className = 'status neutral';
      drilldownTableContainer.innerHTML = '';
      tableContainer.innerHTML = '';
    }

    function renderReportList(filteredForms) {
      if (leftNavMode.value !== 'reports') {
        reportListContainer.innerHTML = '<div class="text-muted small p-2">MDRM view coming soon.</div>';
        return;
      }
      if (!filteredForms.length) {
        reportListContainer.innerHTML = '<div class="text-muted small p-2">No matching reports.</div>';
        return;
      }
      reportListContainer.innerHTML = filteredForms.map(form => `
        <button class="report-item ${form === selectedReportingForm ? 'active' : ''}" type="button" data-report="${escapeHtml(form)}">
          ${escapeHtml(form)}
        </button>
      `).join('');
    }

    function filterAndRenderReportList() {
      if (leftNavMode.value !== 'reports') {
        renderReportList([]);
        return;
      }
      const q = reportSearchInput.value.trim().toLowerCase();
      const filtered = q ? allForms.filter(form => form.toLowerCase().includes(q)) : allForms;
      renderReportList(filtered);
    }

    function renderTable(payload) {
      if (!payload || !payload.columns || !payload.rows) {
        tableContainer.innerHTML = '';
        return;
      }
      const headerHtml = payload.columns.map(c => `<th>${escapeHtml(c)}</th>`).join('');
      const rowsHtml = payload.rows.map(row => {
        const cells = payload.columns.map(c => `<td>${escapeHtml(row[c])}</td>`).join('');
        return `<tr>${cells}</tr>`;
      }).join('');
      tableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead><tr>${headerHtml}</tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function formatRunDate(epochMillis) {
      if (!epochMillis) {
        return '';
      }
      const value = Number(epochMillis);
      if (Number.isNaN(value)) {
        return '';
      }
      return new Date(value).toLocaleString();
    }

    function renderRunHistory(payload) {
      const runs = payload && payload.runs ? payload.runs : [];
      if (!runs.length) {
        summaryTableContainer.innerHTML = '';
        return;
      }
      const rowsHtml = runs.map(run => `
        <tr>
          <td>${escapeHtml(run.runId)}</td>
          <td>${escapeHtml(formatRunDate(run.runDatetime))}</td>
          <td>${escapeHtml(run.fileName)}</td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="TOTAL">${escapeHtml(run.totalUniqueMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="ACTIVE">${escapeHtml(run.activeMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="INACTIVE">${escapeHtml(run.inactiveMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="UPDATED">${escapeHtml(run.updatedMdrms)}</a></td>
          <td>${escapeHtml(run.addedMdrms ?? 0)}</td>
          <td>${escapeHtml(run.modifiedMdrms ?? 0)}</td>
          <td>${escapeHtml(run.deletedMdrms ?? 0)}</td>
        </tr>
      `).join('');
      summaryTableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Run Date</th>
              <th>Source File</th>
              <th>Total Unique MDRMs</th>
              <th>Active</th>
              <th>Inactive</th>
              <th>Updated</th>
              <th>Added</th>
              <th>Modified</th>
              <th>Deleted</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderDrilldown(payload) {
      const codes = payload && payload.mdrmCodes ? payload.mdrmCodes : [];
      drilldownTitle.textContent = `Run ${payload.runId} | ${payload.bucket} MDRMs: ${codes.length}`;
      drilldownTitle.className = 'status ok';
      if (!codes.length) {
        drilldownTableContainer.innerHTML = '';
        return;
      }
      const rowsHtml = codes.map(code => `
        <tr>
          <td><a href="/mdrm.html?mdrm=${encodeURIComponent(code)}">${escapeHtml(code)}</a></td>
        </tr>
      `).join('');
      drilldownTableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead><tr><th>MDRM Code</th></tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderFileMetrics(runs) {
      if (!runs || !runs.length) {
        fileMetricsContainer.innerHTML = '';
        return;
      }
      const rowsHtml = runs.map(run => `
        <tr>
          <td>${escapeHtml(run.runId)}</td>
          <td>${escapeHtml(formatRunDate(run.runDatetime))}</td>
          <td>${escapeHtml(run.fileName)}</td>
          <td>${escapeHtml(run.numFileRecords)}</td>
          <td>${escapeHtml(run.numRecordsIngested)}</td>
          <td>${escapeHtml(run.numRecordsError)}</td>
          <td>${escapeHtml(run.reportsCount)}</td>
          <td>${escapeHtml(run.totalUniqueMdrms)}</td>
          <td>${escapeHtml(run.activeMdrms)}</td>
          <td>${escapeHtml(run.inactiveMdrms)}</td>
          <td>${escapeHtml(run.updatedMdrms)}</td>
          <td><a class="file-inc-link" href="#" data-run-id="${escapeHtml(run.runId)}">View</a></td>
        </tr>
      `).join('');

      fileMetricsContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Run Date</th>
              <th>Source File</th>
              <th>File Rows</th>
              <th>Ingested</th>
              <th>Error</th>
              <th>Reports</th>
              <th>Total MDRMs</th>
              <th>Active</th>
              <th>Inactive</th>
              <th>Updated</th>
              <th>Incremental</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderFileIncremental(runId, rows) {
      fileIncrementalTitle.textContent = `Run ${runId} incremental changes by report`;
      fileIncrementalTitle.className = 'status ok mt-2';
      if (!rows || !rows.length) {
        fileIncrementalContainer.innerHTML = '<div class="text-muted small p-2">No incremental changes for this run.</div>';
        fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
        return;
      }
      const body = rows.map(row => `
        <tr>
          <td>${escapeHtml(row.reportingForm)}</td>
          <td>${escapeHtml(row.addedMdrms)}</td>
          <td>${escapeHtml(row.modifiedMdrms)}</td>
          <td>${escapeHtml(row.deletedMdrms)}</td>
          <td><a class="inc-report-link" href="#" data-run-id="${escapeHtml(runId)}" data-reporting-form="${escapeHtml(row.reportingForm)}">Details</a></td>
        </tr>
      `).join('');
      fileIncrementalContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Reporting Form</th>
              <th>Added</th>
              <th>Modified</th>
              <th>Deleted</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
      `;
      fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
    }

    function renderIncrementalDetailPanel(runId, reportingForm, addedCodes, modifiedCodes, deletedCodes) {
      const sectionIdPrefix = `inc-${runId}-${reportingForm.replaceAll(/[^a-zA-Z0-9]/g, '_')}`;
      const buildRows = codes => {
        if (!codes.length) {
          return '<div class="text-muted small">No MDRMs</div>';
        }
        return `<div class="small" style="max-height: 220px; overflow: auto;"><ul class="mb-0">${codes.map(code => `<li><a href="/mdrm.html?mdrm=${encodeURIComponent(code)}">${escapeHtml(code)}</a></li>`).join('')}</ul></div>`;
      };

      fileIncrementalDetailPanel.innerHTML = `
        <div class="p-2">
          <div class="fw-semibold mb-2">Run ${escapeHtml(runId)} | ${escapeHtml(reportingForm)}</div>
          <div class="accordion" id="${sectionIdPrefix}-accordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-added" aria-expanded="true">
                  Added MDRMs (${addedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-added" class="accordion-collapse collapse show" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(addedCodes)}</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-modified" aria-expanded="false">
                  Modified MDRMs (${modifiedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-modified" class="accordion-collapse collapse" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(modifiedCodes)}</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-deleted" aria-expanded="false">
                  Deleted MDRMs (${deletedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-deleted" class="accordion-collapse collapse" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(deletedCodes)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function switchReportTab(targetTabId) {
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetTabId));
      tabButtons.forEach(button => {
        const active = button.dataset.tab === targetTabId;
        button.classList.toggle('active', active);
        button.setAttribute('aria-selected', String(active));
      });
    }

    async function runLoad() {
      setLoadActionsDisabled(true);
      setLoadStatus('Loading... calling /api/mdrm/load', 'neutral');
      try {
        const response = await fetch('/api/mdrm/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const bodyText = await response.text();
        let payload;
        try {
          payload = bodyText ? JSON.parse(bodyText) : null;
        } catch {
          payload = bodyText;
        }
        if (!response.ok) {
          setLoadStatus(
            `Load failed (HTTP ${response.status})\n${typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2)}`,
            'err'
          );
          return;
        }
        setLoadStatus(`Load successful\n${JSON.stringify(payload, null, 2)}`, 'ok');
        formsLoaded = false;
        await refreshFileMetrics();
      } catch (error) {
        setLoadStatus(`Request error\n${error.message}`, 'err');
      } finally {
        setLoadActionsDisabled(false);
      }
    }

    async function uploadFile() {
      const file = uploadFileInput.files && uploadFileInput.files[0];
      if (!file) {
        setLoadStatus('Select an MDRM_ddyy.csv file first.', 'err');
        return;
      }
      const form = new FormData();
      form.append('file', file);

      setLoadActionsDisabled(true);
      setLoadStatus(`Uploading ${file.name}...`, 'neutral');
      try {
        const response = await fetch('/api/mdrm/upload', {
          method: 'POST',
          body: form
        });
        const bodyText = await response.text();
        let payload;
        try {
          payload = bodyText ? JSON.parse(bodyText) : null;
        } catch {
          payload = bodyText;
        }
        if (!response.ok) {
          setLoadStatus(
            `Upload failed (HTTP ${response.status})\n${typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2)}`,
            'err'
          );
          return;
        }
        setLoadStatus(`Upload successful\n${JSON.stringify(payload, null, 2)}`, 'ok');
        formsLoaded = false;
        uploadFileInput.value = '';
        updateLoadButtonStates();
        await refreshFileMetrics();
      } catch (error) {
        setLoadStatus(`Upload error\n${error.message}`, 'err');
      } finally {
        setLoadActionsDisabled(false);
      }
    }

    async function refreshFileMetrics() {
      try {
        const response = await fetch('/api/mdrm/file-runs');
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        renderFileMetrics(Array.isArray(payload) ? payload : []);
      } catch (error) {
        fileMetricsContainer.innerHTML = '<div class="text-danger small p-2">Failed to load file metrics.</div>';
      }
    }

    async function loadFileIncremental(runId) {
      fileIncrementalTitle.textContent = `Loading incremental changes for run ${runId}...`;
      fileIncrementalTitle.className = 'status neutral mt-2';
      fileIncrementalContainer.innerHTML = '';
      fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
      try {
        const response = await fetch(`/api/mdrm/incremental-summary?runId=${encodeURIComponent(runId)}`);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        renderFileIncremental(runId, Array.isArray(payload) ? payload : []);
      } catch (error) {
        fileIncrementalTitle.textContent = `Failed to load incremental changes for run ${runId}`;
        fileIncrementalTitle.className = 'status err mt-2';
      }
    }

    async function loadIncrementalReportDetails(runId, reportingForm) {
      fileIncrementalDetailPanel.innerHTML = `<div class="text-muted small p-2">Loading details for ${escapeHtml(reportingForm)}...</div>`;
      const queryForm = encodeURIComponent(reportingForm);
      const queryRun = encodeURIComponent(runId);
      try {
        const [addedRes, modifiedRes, deletedRes] = await Promise.all([
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=ADDED`),
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=MODIFIED`),
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=DELETED`)
        ]);
        const [addedPayload, modifiedPayload, deletedPayload] = await Promise.all([
          addedRes.json(),
          modifiedRes.json(),
          deletedRes.json()
        ]);
        if (!addedRes.ok || !modifiedRes.ok || !deletedRes.ok) {
          throw new Error('Failed to load one or more incremental MDRM lists');
        }
        renderIncrementalDetailPanel(
          runId,
          reportingForm,
          Array.isArray(addedPayload.mdrmCodes) ? addedPayload.mdrmCodes : [],
          Array.isArray(modifiedPayload.mdrmCodes) ? modifiedPayload.mdrmCodes : [],
          Array.isArray(deletedPayload.mdrmCodes) ? deletedPayload.mdrmCodes : []
        );
      } catch (error) {
        fileIncrementalDetailPanel.innerHTML = `<div class="text-danger small p-2">Failed to load details for ${escapeHtml(reportingForm)}.</div>`;
      }
    }

    async function refreshForms() {
      setReportingBusy(true);
      try {
        const response = await fetch('/api/mdrm/reporting-forms');
        const forms = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(forms)}`);
        }
        allForms = Array.isArray(forms) ? forms : [];
        formsLoaded = true;
        const reportOption = leftNavMode.querySelector('option[value="reports"]');
        if (reportOption) {
          reportOption.textContent = `Reports (${allForms.length})`;
        }
        filterAndRenderReportList();
      } catch (error) {
        console.error('Failed to load report list', error);
      } finally {
        setReportingBusy(false);
      }
    }

    async function loadTable(reportingForm) {
      if (!reportingForm) {
        return;
      }
      setReportingBusy(true);
      selectedReportLabel.textContent = `Selected Report: ${reportingForm}`;
      clearReportData();
      try {
        const query = encodeURIComponent(reportingForm);
        const [historyResponse, detailsResponse] = await Promise.all([
          fetch(`/api/mdrm/run-history?reportingForm=${query}`),
          fetch(`/api/mdrm/data?reportingForm=${query}`)
        ]);
        const historyPayload = await historyResponse.json();
        const detailsPayload = await detailsResponse.json();
        if (!historyResponse.ok) {
          throw new Error(`Run history HTTP ${historyResponse.status}: ${JSON.stringify(historyPayload)}`);
        }
        if (!detailsResponse.ok) {
          throw new Error(`Details HTTP ${detailsResponse.status}: ${JSON.stringify(detailsPayload)}`);
        }
        renderRunHistory(historyPayload);
        renderTable(detailsPayload);
      } catch (error) {
        summaryTableContainer.innerHTML = '';
        tableContainer.innerHTML = '';
        console.error('Failed to load report data', error);
      } finally {
        setReportingBusy(false);
      }
    }

    runLoadBtn.addEventListener('click', runLoad);
    uploadFileBtn.addEventListener('click', uploadFile);
    uploadFileInput.addEventListener('change', updateLoadButtonStates);

    reportSearchInput.addEventListener('input', filterAndRenderReportList);

    leftNavMode.addEventListener('change', () => {
      if (leftNavMode.value === 'mdrms') {
        reportSearchInput.disabled = true;
        selectedReportLabel.textContent = 'Selected Report: -';
        selectedReportingForm = '';
        clearReportData();
      } else {
        reportSearchInput.disabled = false;
      }
      filterAndRenderReportList();
    });

    tabButtons.forEach(button => {
      button.addEventListener('click', event => {
        event.preventDefault();
        switchReportTab(button.dataset.tab);
      });
    });

    reportListContainer.addEventListener('click', event => {
      if (leftNavMode.value !== 'reports') {
        return;
      }
      const button = event.target.closest('.report-item');
      if (!button) {
        return;
      }
      selectedReportingForm = button.dataset.report || '';
      filterAndRenderReportList();
      loadTable(selectedReportingForm);
    });

    summaryTableContainer.addEventListener('click', async event => {
      if (leftNavMode.value !== 'reports') {
        return;
      }
      const link = event.target.closest('.count-link');
      if (!link || !selectedReportingForm) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      const bucket = link.dataset.bucket;
      const query = encodeURIComponent(selectedReportingForm);
      drilldownTitle.textContent = `Loading ${bucket} MDRM codes for run ${runId}...`;
      drilldownTitle.className = 'status neutral';
      drilldownTableContainer.innerHTML = '';
      try {
        const response = await fetch(`/api/mdrm/run-mdrms?reportingForm=${query}&runId=${encodeURIComponent(runId)}&bucket=${encodeURIComponent(bucket)}`);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        renderDrilldown(payload);
      } catch (error) {
        drilldownTitle.textContent = `Failed to load MDRM drilldown\n${error.message}`;
        drilldownTitle.className = 'status err';
      }
    });

    fileMetricsContainer.addEventListener('click', event => {
      const link = event.target.closest('.file-inc-link');
      if (!link) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      if (!runId) {
        return;
      }
      loadFileIncremental(runId);
    });

    fileIncrementalContainer.addEventListener('click', event => {
      const link = event.target.closest('.inc-report-link');
      if (!link) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      const reportingForm = link.dataset.reportingForm;
      if (!runId || !reportingForm) {
        return;
      }
      loadIncrementalReportDetails(runId, reportingForm);
    });

    refreshFileMetrics();
    updateLoadButtonStates();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
