<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDRM Search & Discovery Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Manrope', 'ui-sans-serif', 'system-ui']
          },
          colors: {
            ink: {
              950: '#0a1323',
              900: '#12243c',
              800: '#1a3556'
            },
            skybrand: {
              400: '#4ea3ff',
              500: '#2d8dff'
            }
          },
          boxShadow: {
            soft: '0 20px 60px rgba(9,20,40,0.18)'
          }
        }
      }
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-theme-quartz.css">
  <link rel="stylesheet" href="/css/mdrm-console.css">
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-100 via-slate-50 to-slate-100 text-slate-900 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 dark:text-slate-100">
  <main class="shell !max-w-7xl !px-4 md:!px-6 !py-5">
    <header class="topbar panel !rounded-2xl !border-slate-200/80 !bg-white/90 !shadow-soft dark:!border-slate-700 dark:!bg-slate-900/90">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 class="!font-semibold !text-slate-900 dark:!text-slate-100">FedMDRM</h1>
          <p class="!text-slate-500 dark:!text-slate-300">Search and Discovery Console</p>
        </div>
      </div>
      <nav class="menu" aria-label="MDRM Menu">
        <a id="menu-discovery" class="menu-link active !rounded-full !px-4 !py-2 !text-xs !font-semibold" data-view="view-discovery" href="#">
          <span class="menu-link-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M11 4a7 7 0 105.2 11.7l3.6 3.6 1.4-1.4-3.6-3.6A7 7 0 0011 4z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          <span class="menu-link-label">Discovery</span>
        </a>
        <a id="menu-bookmarks" class="menu-link !rounded-full !px-4 !py-2 !text-xs !font-semibold" data-view="view-bookmarks" href="#">
          <span class="menu-link-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 17.3l-5.2 3 1.2-5.9-4.4-4.2 6-.7L12 4l2.4 5.5 6 .7-4.4 4.2 1.2 5.9-5.2-3z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
          </span>
          <span class="menu-link-label">Bookmarks</span>
        </a>
        <a id="menu-reporting" class="menu-link !rounded-full !px-4 !py-2 !text-xs !font-semibold" data-view="view-reporting" href="#">
          <span class="menu-link-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M5 19V9m7 10V5m7 14v-7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M3.5 20.5h17" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
          </span>
          <span class="menu-link-label">Reporting Viewer</span>
        </a>
        <a id="menu-load" class="menu-link !rounded-full !px-4 !py-2 !text-xs !font-semibold" data-view="view-load" href="#">
          <span class="menu-link-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 4v11m0 0l4-4m-4 4l-4-4M5 19h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          <span class="menu-link-label">Load MDRM</span>
        </a>
      </nav>
      <div class="header-actions">
        <button id="themeIconBtn" class="theme-icon-btn" type="button" aria-label="Toggle theme">â˜€</button>
      <div class="profile-wrap">
        <button id="profileMenuBtn" class="profile-btn" type="button" aria-haspopup="true" aria-expanded="false">
          <span id="profileNameLabel" class="profile-name">Guest</span>
          <span class="chev" aria-hidden="true">â–¾</span>
        </button>
        <div id="profileMenu" class="profile-menu" role="menu" aria-label="Profile options">
          <div id="authStatusLabel" class="status neutral">Not logged in</div>
          <div id="authInputRows" class="row g-2 mt-2">
            <div id="authModeRow" class="col-12 d-flex gap-2">
              <button id="authModeLoginBtn" class="btn btn-outline-primary w-100" type="button">Login</button>
              <button id="authModeRegisterBtn" class="btn btn-outline-primary w-100" type="button">Sign Up</button>
              <button id="authModeResetBtn" class="btn btn-outline-primary w-100" type="button">Reset</button>
            </div>
            <div id="authEmailCol" class="col-12">
              <input id="authEmailInput" class="form-control" type="email" placeholder="Email">
            </div>
            <div id="authFirstNameCol" class="col-6">
              <input id="authFirstNameInput" class="form-control" type="text" placeholder="First name (sign up)">
            </div>
            <div id="authLastNameCol" class="col-6">
              <input id="authLastNameInput" class="form-control" type="text" placeholder="Last name (sign up)">
            </div>
            <div id="authPasswordCol" class="col-12">
              <input id="authPasswordInput" class="form-control" type="password" placeholder="Password">
            </div>
            <div id="authConfirmPasswordCol" class="col-12">
              <input id="authConfirmPasswordInput" class="form-control" type="password" placeholder="Re-enter password">
            </div>
            <div id="authShowPasswordCol" class="col-12">
              <div class="form-check">
                <input id="authShowPasswordInput" class="form-check-input" type="checkbox">
                <label class="form-check-label small" for="authShowPasswordInput">Show password</label>
              </div>
            </div>
            <div id="authLoginCol" class="col-12">
              <button id="authLoginBtn" class="btn btn-primary w-100" type="button">Login</button>
            </div>
            <div id="authRegisterCol" class="col-12">
              <button id="authRegisterBtn" class="btn btn-outline-primary w-100" type="button">Sign Up</button>
            </div>
            <div id="authResetCol" class="col-12">
              <button id="authResetBtn" class="btn btn-outline-warning w-100" type="button">Reset Password</button>
            </div>
            <div id="authLogoutCol" class="col-12">
              <button id="authLogoutBtn" class="btn btn-outline-danger w-100" type="button" disabled>Logout</button>
            </div>
          </div>
        </div>
      </div>
      </div>
    </header>

    <section class="panel hero !rounded-2xl !border-slate-200/80 !shadow-soft dark:!border-slate-700">
      <div class="hero-copy">
        <h2 class="!font-semibold !text-slate-900 dark:!text-slate-100">Fed Micro Data Reference Manual Discovery Tool</h2>
        <p class="!text-slate-600 dark:!text-slate-300">Search reporting forms, inspect run history, and drill down into MDRM changes from one workspace.</p>
      </div>
      <div class="hero-kpis">
        <div class="kpi !bg-white/85 !border-slate-200 dark:!bg-slate-800/70 dark:!border-slate-700">
          <div id="kpiReportCount" class="kpi-label">0</div>
          <div class="kpi-value">Unique Reports</div>
        </div>
        <div class="kpi !bg-white/85 !border-slate-200 dark:!bg-slate-800/70 dark:!border-slate-700">
          <div id="kpiMdrmCount" class="kpi-label">0</div>
          <div class="kpi-value">MDRMs</div>
        </div>
        <div class="kpi !bg-white/85 !border-slate-200 dark:!bg-slate-800/70 dark:!border-slate-700">
          <div id="kpiActiveView" class="kpi-label">Discovery</div>
          <div class="kpi-value">Current View</div>
        </div>
      </div>
    </section>

    <section id="discoveryRecentPanel" class="panel !rounded-2xl !border-slate-200/80 !bg-white/90 !shadow-soft dark:!border-slate-700 dark:!bg-slate-900/90">
      <section class="recent-strip">
        <div class="sectionTitle compact">
          <h3>Recent Items</h3>
          <button id="clearRecentItemsBtn" class="btn btn-sm btn-outline-secondary" type="button">Clear</button>
        </div>
        <div id="recentItemsContainer" class="recent-items-row"></div>
      </section>
    </section>

    <section id="view-discovery" class="panel view active !rounded-2xl !border-slate-200/80 !bg-white/90 !shadow-soft dark:!border-slate-700 dark:!bg-slate-900/90">
      <section class="discovery-main">
        <div class="sectionTitle">
          <h3>Search and discovery</h3>
          <p>Find MDRMs fast, then save important ones to bookmarks.</p>
        </div>
        <div class="searchBoxLite mt-2">
          <input id="discoveryQueryInput" class="form-control !rounded-xl !border-slate-300 !bg-white !text-sm dark:!border-slate-600 dark:!bg-slate-800 dark:!text-slate-100" type="text"
                 placeholder="Search MDRM elements, reports, keywords... e.g. RCFN1415, assets, FRY9C">
          <button id="discoverySearchBtn" class="btn btn-primary action-btn !rounded-xl !px-5 !font-semibold" type="button">Search</button>
        </div>
        <div id="discoveryFiltersRow" class="row g-2 mt-2" style="display:none;">
          <div class="col-md-4">
            <input id="filterCodeInput" class="form-control form-control-sm" type="text" placeholder="Filter MDRM code">
          </div>
          <div class="col-md-4">
            <input id="filterDescriptionInput" class="form-control form-control-sm" type="text" placeholder="Filter description">
          </div>
          <div class="col-md-4">
            <input id="filterReportingFormInput" class="form-control form-control-sm" type="text" placeholder="Filter reporting form">
          </div>
        </div>
        <div id="discoverySearchResults" class="card-shell mt-3" style="display:none;">
          <div class="discovery-grid-headline">
            <div id="discoveryResultMeta" class="discovery-result-meta"></div>
            <div class="discovery-toolbar-right">
              <input id="discoveryQuickFilterInput" class="form-control form-control-sm discovery-quick-filter" type="text" placeholder="Filter results...">
            </div>
          </div>
          <div id="discoveryGrid" class="mdrm-ag-grid ag-theme-quartz" style="display:none;"></div>
        </div>
      </section>
    </section>

    <section id="view-bookmarks" class="panel view">
      <div class="bookmarks-layout">
        <aside class="bookmarks-sidebar card-shell p-3">
          <div class="sectionTitle">
            <h3>Bookmarks</h3>
            <p id="bookmarkUserLabel" class="muted">Login required</p>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-8">
              <input id="newGroupNameInput" class="form-control" type="text" placeholder="New group name">
            </div>
            <div class="col-4">
              <button id="createGroupBtn" class="btn btn-outline-primary w-100" type="button" disabled>Create</button>
            </div>
            <div class="col-12">
              <select id="bookmarkFilterGroupSelect" class="form-select" disabled>
                <option value="">Browse all groups</option>
              </select>
            </div>
            <div class="col-8">
              <input id="renameGroupNameInput" class="form-control" type="text" placeholder="Rename selected group">
            </div>
            <div class="col-4 d-flex gap-1">
              <button id="renameGroupBtn" class="btn btn-outline-secondary w-100" type="button" disabled>Rename</button>
              <button id="deleteGroupBtn" class="btn btn-outline-danger w-100" type="button" disabled>Delete</button>
            </div>
          </div>
          <div id="bookmarkGroupsContainer" class="bookmark-box mt-3"></div>
        </aside>
        <section class="bookmarks-main card-shell p-3">
          <div class="sectionTitle compact">
            <h3>Saved MDRMs</h3>
            <p>Browse and manage saved items.</p>
          </div>
          <div id="bookmarkItemsContainer" class="bookmark-box mt-2"></div>
        </section>
      </div>
    </section>

    <section id="view-load" class="panel view">
      <div class="row g-2 align-items-center">
        <div class="col-md-6 col-lg-7">
          <input id="uploadFileInput" class="form-control" type="file" accept=".csv">
        </div>
        <div class="col-auto">
          <button id="uploadFileBtn" class="btn btn-outline-primary action-btn" type="button">Upload</button>
        </div>
        <div class="col-auto">
          <button id="runLoadBtn" class="primary btn btn-primary action-btn" type="button" disabled>Run Load</button>
        </div>
      </div>
      <div id="loadStatus" class="status neutral mt-3">Ready.</div>
      <div id="fileMetricsContainer" class="table-shell mt-3 card-shell"></div>
      <div id="fileIncrementalTitle" class="status neutral mt-2">Select a run to view incremental changes by report.</div>
      <div class="row g-3">
        <div class="col-lg-7">
          <div id="fileIncrementalContainer" class="table-shell card-shell"></div>
        </div>
        <div class="col-lg-5">
          <div id="fileIncrementalDetailPanel" class="table-shell card-shell"></div>
        </div>
      </div>
    </section>

    <section id="view-reporting" class="panel view">
      <div class="reporting-layout">
        <aside class="report-list-pane">
          <select id="leftNavMode" class="form-select form-select-sm">
            <option value="reports">Reports (0)</option>
            <option value="mdrms">MDRMs</option>
          </select>
          <input id="reportSearchInput" class="form-control" type="text" placeholder="Search reports...">
          <div id="reportListContainer" class="report-list"></div>
        </aside>

        <section class="report-main-pane">
          <div class="report-header">
            <div id="selectedReportLabel" class="selected-report">Selected Report: -</div>
            <div class="tab-row" role="tablist" aria-label="Report views">
              <a id="tabSummaryBtn" class="tab-link active" href="#" data-tab="summaryTab" role="tab" aria-selected="true">Run Summary</a>
              <a id="tabDetailsBtn" class="tab-link" href="#" data-tab="detailsTab" role="tab" aria-selected="false">Regular Details</a>
            </div>
          </div>

          <section id="summaryTab" class="tab-panel active" role="tabpanel" aria-labelledby="tabSummaryBtn">
            <div id="summaryTableContainer" class="table-shell card-shell"></div>
            <div id="drilldownTitle" class="status neutral">Select a count to view MDRM codes.</div>
            <div id="drilldownTableContainer" class="table-shell card-shell"></div>
          </section>

          <section id="detailsTab" class="tab-panel" role="tabpanel" aria-labelledby="tabDetailsBtn">
            <div id="tableContainer" class="table-shell card-shell"></div>
          </section>
        </section>
      </div>
    </section>
  </main>

  <div class="modal fade" id="saveBookmarkModal" tabindex="-1" aria-labelledby="saveBookmarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="saveBookmarkModalLabel">Save Bookmark</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="saveBookmarkContext" class="small text-muted mb-2"></div>
          <div class="mb-2">
            <label class="form-label small mb-1" for="saveBookmarkGroupSelect">Save to</label>
            <select id="saveBookmarkGroupSelect" class="form-select">
              <option value="">Default Favorites</option>
            </select>
          </div>
          <div id="saveBookmarkNewGroupWrap" class="mb-2" style="display:none;">
            <label class="form-label small mb-1" for="saveBookmarkNewGroupInput">New group name</label>
            <input id="saveBookmarkNewGroupInput" class="form-control" type="text" placeholder="e.g. Liquidity checks">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveBookmarkConfirmBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/dist/ag-grid-community.min.js"></script>
  <script>
    const menuButtons = Array.from(document.querySelectorAll('.menu-link'));
    const views = Array.from(document.querySelectorAll('.view'));
    let formsLoaded = false;
    let allForms = [];
    let selectedReportingForm = '';

    function switchView(targetViewId) {
      views.forEach(view => view.classList.toggle('active', view.id === targetViewId));
      menuButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === targetViewId));
      if (discoveryRecentPanel) {
        discoveryRecentPanel.style.display = targetViewId === 'view-discovery' ? '' : 'none';
      }
      if (kpiActiveView) {
        if (targetViewId === 'view-reporting') {
          kpiActiveView.textContent = 'Reporting Viewer';
        } else if (targetViewId === 'view-bookmarks') {
          kpiActiveView.textContent = 'Bookmarks';
        } else if (targetViewId === 'view-load') {
          kpiActiveView.textContent = 'Load MDRM';
        } else {
          kpiActiveView.textContent = 'Discovery';
        }
      }
      if (targetViewId === 'view-reporting' && !formsLoaded) {
        refreshForms();
      }
      if (targetViewId === 'view-bookmarks' && currentUser) {
        refreshBookmarks();
      }
    }

    menuButtons.forEach(button => {
      button.addEventListener('click', event => {
        if (!button.dataset.view) {
          return;
        }
        event.preventDefault();
        switchView(button.dataset.view);
      });
    });

    const runLoadBtn = document.getElementById('runLoadBtn');
    const uploadFileInput = document.getElementById('uploadFileInput');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const loadStatus = document.getElementById('loadStatus');
    const fileMetricsContainer = document.getElementById('fileMetricsContainer');
    const fileIncrementalTitle = document.getElementById('fileIncrementalTitle');
    const fileIncrementalContainer = document.getElementById('fileIncrementalContainer');
    const fileIncrementalDetailPanel = document.getElementById('fileIncrementalDetailPanel');
    const leftNavMode = document.getElementById('leftNavMode');
    const reportSearchInput = document.getElementById('reportSearchInput');
    const reportListContainer = document.getElementById('reportListContainer');
    const selectedReportLabel = document.getElementById('selectedReportLabel');
    const tableContainer = document.getElementById('tableContainer');
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    const drilldownTitle = document.getElementById('drilldownTitle');
    const drilldownTableContainer = document.getElementById('drilldownTableContainer');
    const tabButtons = Array.from(document.querySelectorAll('.tab-link'));
    const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
    const kpiReportCount = document.getElementById('kpiReportCount');
    const kpiMdrmCount = document.getElementById('kpiMdrmCount');
    const kpiActiveView = document.getElementById('kpiActiveView');
    const discoveryRecentPanel = document.getElementById('discoveryRecentPanel');
    const discoveryQueryInput = document.getElementById('discoveryQueryInput');
    const discoverySearchBtn = document.getElementById('discoverySearchBtn');
    const discoveryFiltersRow = document.getElementById('discoveryFiltersRow');
    const filterCodeInput = document.getElementById('filterCodeInput');
    const filterDescriptionInput = document.getElementById('filterDescriptionInput');
    const filterReportingFormInput = document.getElementById('filterReportingFormInput');
    const discoveryResultMeta = document.getElementById('discoveryResultMeta');
    const discoveryQuickFilterInput = document.getElementById('discoveryQuickFilterInput');
    const discoverySearchResults = document.getElementById('discoverySearchResults');
    const discoveryGrid = document.getElementById('discoveryGrid');
    const recentItemsContainer = document.getElementById('recentItemsContainer');
    const clearRecentItemsBtn = document.getElementById('clearRecentItemsBtn');
    const authStatusLabel = document.getElementById('authStatusLabel');
    const authModeRow = document.getElementById('authModeRow');
    const authModeLoginBtn = document.getElementById('authModeLoginBtn');
    const authModeRegisterBtn = document.getElementById('authModeRegisterBtn');
    const authModeResetBtn = document.getElementById('authModeResetBtn');
    const authEmailInput = document.getElementById('authEmailInput');
    const authFirstNameInput = document.getElementById('authFirstNameInput');
    const authLastNameInput = document.getElementById('authLastNameInput');
    const authPasswordInput = document.getElementById('authPasswordInput');
    const authConfirmPasswordInput = document.getElementById('authConfirmPasswordInput');
    const authShowPasswordInput = document.getElementById('authShowPasswordInput');
    const authEmailCol = document.getElementById('authEmailCol');
    const authFirstNameCol = document.getElementById('authFirstNameCol');
    const authLastNameCol = document.getElementById('authLastNameCol');
    const authPasswordCol = document.getElementById('authPasswordCol');
    const authConfirmPasswordCol = document.getElementById('authConfirmPasswordCol');
    const authShowPasswordCol = document.getElementById('authShowPasswordCol');
    const authInputRows = document.getElementById('authInputRows');
    const authLoginCol = document.getElementById('authLoginCol');
    const authRegisterCol = document.getElementById('authRegisterCol');
    const authResetCol = document.getElementById('authResetCol');
    const authLogoutCol = document.getElementById('authLogoutCol');
    const authLoginBtn = document.getElementById('authLoginBtn');
    const authRegisterBtn = document.getElementById('authRegisterBtn');
    const authResetBtn = document.getElementById('authResetBtn');
    const authLogoutBtn = document.getElementById('authLogoutBtn');
    const bookmarkUserLabel = document.getElementById('bookmarkUserLabel');
    const newGroupNameInput = document.getElementById('newGroupNameInput');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const bookmarkFilterGroupSelect = document.getElementById('bookmarkFilterGroupSelect');
    const renameGroupNameInput = document.getElementById('renameGroupNameInput');
    const renameGroupBtn = document.getElementById('renameGroupBtn');
    const deleteGroupBtn = document.getElementById('deleteGroupBtn');
    const bookmarkGroupsContainer = document.getElementById('bookmarkGroupsContainer');
    const bookmarkItemsContainer = document.getElementById('bookmarkItemsContainer');
    const saveBookmarkModalEl = document.getElementById('saveBookmarkModal');
    const saveBookmarkGroupSelect = document.getElementById('saveBookmarkGroupSelect');
    const saveBookmarkNewGroupWrap = document.getElementById('saveBookmarkNewGroupWrap');
    const saveBookmarkNewGroupInput = document.getElementById('saveBookmarkNewGroupInput');
    const saveBookmarkContext = document.getElementById('saveBookmarkContext');
    const saveBookmarkConfirmBtn = document.getElementById('saveBookmarkConfirmBtn');
    const profileNameLabel = document.getElementById('profileNameLabel');
    const themeIconBtn = document.getElementById('themeIconBtn');
    const profileMenuBtn = document.getElementById('profileMenuBtn');
    const profileMenu = document.getElementById('profileMenu');
    const THEME_KEY = 'mdrm-ui-theme';
    const LOCAL_RECENT_ITEMS_KEY = 'mdrm-recent-items-v1';
    const RECENT_ITEMS_MAX = 10;
    let currentUser = null;
    let bookmarkGroups = [];
    let bookmarkItems = [];
    let csrfToken = '';
    let lastDiscoveryRows = [];
    let discoveryGridApi = null;
    let pendingBookmarkPayload = null;
    let saveBookmarkModal = null;
    let authMode = '';
    let recentItems = [];

    function hasSelectedUploadFile() {
      return !!(uploadFileInput.files && uploadFileInput.files.length > 0);
    }

    function updateLoadButtonStates() {
      runLoadBtn.disabled = !hasSelectedUploadFile();
    }

    function setLoadStatus(text, css) {
      loadStatus.textContent = text;
      loadStatus.className = `status ${css}`;
    }

    function setLoadActionsDisabled(disabled) {
      runLoadBtn.disabled = disabled || !hasSelectedUploadFile();
      uploadFileBtn.disabled = disabled;
      uploadFileInput.disabled = disabled;
    }

    function setReportingBusy(isBusy) {
      reportSearchInput.disabled = isBusy;
      leftNavMode.disabled = isBusy;
      reportListContainer.classList.toggle('busy', isBusy);
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function clearReportData() {
      summaryTableContainer.innerHTML = '';
      drilldownTitle.textContent = 'Select a count to view MDRM codes.';
      drilldownTitle.className = 'status neutral';
      drilldownTableContainer.innerHTML = '';
      tableContainer.innerHTML = '';
    }

    function renderReportList(filteredForms) {
      if (leftNavMode.value !== 'reports') {
        reportListContainer.innerHTML = '<div class="text-muted small p-2">MDRM view coming soon.</div>';
        return;
      }
      if (!filteredForms.length) {
        reportListContainer.innerHTML = '<div class="text-muted small p-2">No matching reports.</div>';
        return;
      }
      reportListContainer.innerHTML = filteredForms.map(form => `
        <button class="report-item ${form === selectedReportingForm ? 'active' : ''}" type="button" data-report="${escapeHtml(form)}">
          ${escapeHtml(form)}
        </button>
      `).join('');
    }

    function filterAndRenderReportList() {
      if (leftNavMode.value !== 'reports') {
        renderReportList([]);
        return;
      }
      const q = reportSearchInput.value.trim().toLowerCase();
      const filtered = q ? allForms.filter(form => form.toLowerCase().includes(q)) : allForms;
      renderReportList(filtered);
    }

    function closeProfileMenu() {
      if (!profileMenu || !profileMenuBtn) {
        return;
      }
      profileMenu.classList.remove('open');
      profileMenuBtn.setAttribute('aria-expanded', 'false');
    }

    function setAuthMode(mode) {
      authMode = mode === 'login' || mode === 'register' || mode === 'reset' ? mode : '';
      if (authModeLoginBtn) {
        authModeLoginBtn.classList.toggle('btn-primary', authMode === 'login');
        authModeLoginBtn.classList.toggle('btn-outline-primary', authMode !== 'login');
      }
      if (authModeRegisterBtn) {
        authModeRegisterBtn.classList.toggle('btn-primary', authMode === 'register');
        authModeRegisterBtn.classList.toggle('btn-outline-primary', authMode !== 'register');
      }
      if (authModeResetBtn) {
        authModeResetBtn.classList.toggle('btn-warning', authMode === 'reset');
        authModeResetBtn.classList.toggle('btn-outline-primary', authMode !== 'reset');
      }
      if (currentUser) {
        return;
      }
      const showBase = !!authMode;
      const isRegister = authMode === 'register';
      const isReset = authMode === 'reset';
      if (authEmailCol) authEmailCol.style.display = showBase ? '' : 'none';
      if (authPasswordCol) authPasswordCol.style.display = showBase ? '' : 'none';
      if (authFirstNameCol) authFirstNameCol.style.display = isRegister ? '' : 'none';
      if (authLastNameCol) authLastNameCol.style.display = isRegister ? '' : 'none';
      if (authConfirmPasswordCol) authConfirmPasswordCol.style.display = (isRegister || isReset) ? '' : 'none';
      if (authShowPasswordCol) authShowPasswordCol.style.display = showBase ? '' : 'none';
      if (authLoginCol) authLoginCol.style.display = authMode === 'login' ? '' : 'none';
      if (authRegisterCol) authRegisterCol.style.display = isRegister ? '' : 'none';
      if (authResetCol) authResetCol.style.display = isReset ? '' : 'none';
      if (authPasswordInput) {
        authPasswordInput.placeholder = isReset ? 'New password' : 'Password';
      }
      if (authConfirmPasswordInput) {
        authConfirmPasswordInput.placeholder = isReset ? 'Confirm new password' : 'Re-enter password';
      }
    }

    function setPasswordVisibility(show) {
      const type = show ? 'text' : 'password';
      if (authPasswordInput) {
        authPasswordInput.type = type;
      }
      if (authConfirmPasswordInput) {
        authConfirmPasswordInput.type = type;
      }
    }

    function setTheme(theme) {
      const nextTheme = theme === 'dark' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', nextTheme);
      document.documentElement.classList.toggle('dark', nextTheme === 'dark');
      applyDiscoveryGridTheme(nextTheme);
      localStorage.setItem(THEME_KEY, nextTheme);
      if (themeIconBtn) {
        themeIconBtn.textContent = nextTheme === 'dark' ? 'â˜€' : 'â˜¾';
        themeIconBtn.setAttribute('aria-label', nextTheme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
      }
    }

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') {
        setTheme(saved);
        return;
      }
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(prefersDark ? 'dark' : 'light');
    }

    async function ensureCsrfToken(forceRefresh = false) {
      if (csrfToken && !forceRefresh) {
        return csrfToken;
      }
      const response = await fetch('/api/auth/csrf');
      if (!response.ok) {
        throw new Error(`Failed to fetch CSRF token (HTTP ${response.status})`);
      }
      const payload = await response.json();
      csrfToken = payload && payload.token ? payload.token : '';
      if (!csrfToken) {
        throw new Error('CSRF token missing');
      }
      return csrfToken;
    }

    async function apiFetch(url, options = {}, retry = true) {
      const method = (options.method || 'GET').toUpperCase();
      const headers = { ...(options.headers || {}) };

      if (!['GET', 'HEAD', 'OPTIONS'].includes(method)) {
        const token = await ensureCsrfToken();
        headers['X-CSRF-Token'] = token;
      }

      const response = await fetch(url, { ...options, headers });
      if (response.status === 403 && retry && !['GET', 'HEAD', 'OPTIONS'].includes(method)) {
        await ensureCsrfToken(true);
        return apiFetch(url, options, false);
      }
      return response;
    }

    function setDiscoveryMeta(text) {
      if (discoveryResultMeta) {
        discoveryResultMeta.textContent = text;
      }
    }

    function setDiscoveryResultsVisible(visible) {
      if (discoverySearchResults) {
        discoverySearchResults.style.display = visible ? '' : 'none';
      }
    }

    function formatCount(value) {
      const n = Number(value);
      if (Number.isNaN(n)) {
        return '0';
      }
      return n.toLocaleString('en-US');
    }

    function loadRecentItemsFromLocal() {
      try {
        const parsed = JSON.parse(localStorage.getItem(LOCAL_RECENT_ITEMS_KEY) || '[]');
        recentItems = Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        recentItems = [];
      }
      recentItems = recentItems
        .filter(item => item && item.type && item.key && item.label)
        .slice(0, RECENT_ITEMS_MAX);
    }

    async function loadRecentItems() {
      if (!currentUser) {
        loadRecentItemsFromLocal();
        renderRecentItems();
        return;
      }
      try {
        const response = await fetch(`/api/recent/items?limit=${RECENT_ITEMS_MAX}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const payload = await response.json();
        recentItems = (Array.isArray(payload) ? payload : []).map(item => ({
          type: String(item.itemType || '').trim().toLowerCase(),
          key: String(item.itemKey || '').trim(),
          label: String(item.label || item.itemKey || '').trim(),
          subtitle: String(item.subtitle || '').trim(),
          url: String(item.url || '').trim(),
          timestamp: Number(item.lastAccessed || Date.now())
        }));
      } catch (error) {
        loadRecentItemsFromLocal();
      }
      renderRecentItems();
    }

    function saveRecentItems() {
      localStorage.setItem(LOCAL_RECENT_ITEMS_KEY, JSON.stringify(recentItems.slice(0, RECENT_ITEMS_MAX)));
    }

    async function persistRecentItemToServer(item) {
      const response = await apiFetch(`/api/recent/items?limit=${RECENT_ITEMS_MAX}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          itemType: item.type,
          itemKey: item.key,
          label: item.label,
          subtitle: item.subtitle || '',
          url: item.url || ''
        })
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const payload = await response.json();
      recentItems = (Array.isArray(payload) ? payload : []).map(entry => ({
        type: String(entry.itemType || '').trim().toLowerCase(),
        key: String(entry.itemKey || '').trim(),
        label: String(entry.label || entry.itemKey || '').trim(),
        subtitle: String(entry.subtitle || '').trim(),
        url: String(entry.url || '').trim(),
        timestamp: Number(entry.lastAccessed || Date.now())
      }));
      renderRecentItems();
    }

    async function recordRecentItem(item) {
      if (!item || !item.type || !item.key || !item.label) {
        return;
      }
      const normalizedType = String(item.type).trim().toLowerCase();
      const normalizedKey = String(item.key).trim();
      if (!normalizedType || !normalizedKey) {
        return;
      }
      recentItems = recentItems.filter(existing =>
        !(String(existing.type).trim().toLowerCase() === normalizedType && String(existing.key).trim() === normalizedKey)
      );
      recentItems.unshift({
        type: normalizedType,
        key: normalizedKey,
        label: String(item.label || normalizedKey).trim(),
        subtitle: String(item.subtitle || '').trim(),
        url: String(item.url || '').trim(),
        timestamp: Date.now()
      });
      recentItems = recentItems.slice(0, RECENT_ITEMS_MAX);
      saveRecentItems();
      renderRecentItems();
      if (currentUser) {
        try {
          await persistRecentItemToServer(item);
        } catch (error) {
          // keep local in-memory list if server call fails
        }
      } else {
        saveRecentItems();
      }
    }

    function renderRecentItems() {
      if (!recentItemsContainer) {
        return;
      }
      if (!recentItems.length) {
        recentItemsContainer.innerHTML = '<div class="text-muted small p-2">No recent items yet.</div>';
        return;
      }
      recentItemsContainer.innerHTML = recentItems.map((item, index) => `
        <div class="recent-item-card" role="button" tabindex="0" data-recent-index="${index}">
          <button class="recent-bookmark-btn ${isRecentItemBookmarked(item) ? 'active' : ''}" type="button" data-recent-bookmark-index="${index}" title="${isRecentItemBookmarked(item) ? 'Bookmarked' : 'Bookmark'}">
            ${isRecentItemBookmarked(item) ? 'â˜…' : 'â˜†'}
          </button>
          <div class="recent-item-type ${item.type === 'report' ? 'report' : 'mdrm'}">
            <span class="recent-item-type-icon" aria-hidden="true">${item.type === 'report' ? 'ðŸ“Š' : 'ðŸ§¾'}</span>
            <span>${escapeHtml(item.type === 'report' ? 'Report' : 'MDRM')}</span>
          </div>
          <div class="recent-item-title">${escapeHtml(item.label)}</div>
          ${item.subtitle ? `<div class="recent-item-subtitle">${escapeHtml(item.subtitle)}</div>` : ''}
        </div>
      `).join('');
    }

    function isRecentItemBookmarked(item) {
      if (!item) {
        return false;
      }
      const targetType = String(item.type || '').trim().toLowerCase();
      const targetKey = String(item.key || '').trim();
      return (bookmarkItems || []).some(bookmark =>
        String(bookmark.itemType || '').trim().toLowerCase() === targetType
        && String(bookmark.itemKey || '').trim() === targetKey
      );
    }

    function findBookmarkIdForRecentItem(item) {
      if (!item) {
        return null;
      }
      const targetType = String(item.type || '').trim().toLowerCase();
      const targetKey = String(item.key || '').trim();
      const bookmark = (bookmarkItems || []).find(entry =>
        String(entry.itemType || '').trim().toLowerCase() === targetType
        && String(entry.itemKey || '').trim() === targetKey
      );
      return bookmark ? Number(bookmark.bookmarkId) : null;
    }

    async function toggleRecentItemBookmark(index) {
      const item = recentItems[index];
      if (!item) {
        return;
      }
      if (!currentUser) {
        setAuthStatus('Login required to save bookmarks.', 'err');
        if (profileMenu && profileMenuBtn) {
          profileMenu.classList.add('open');
          profileMenuBtn.setAttribute('aria-expanded', 'true');
        }
        return;
      }
      const existingBookmarkId = findBookmarkIdForRecentItem(item);
      if (existingBookmarkId) {
        await removeBookmark(existingBookmarkId);
        renderRecentItems();
        return;
      }
      const response = await apiFetch('/api/bookmarks/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          groupId: null,
          itemType: item.type,
          itemKey: item.key,
          title: item.label,
          subtitle: item.subtitle || '',
          url: item.url || ''
        })
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      await refreshBookmarks();
      renderRecentItems();
    }

    function openRecentItem(index) {
      const item = recentItems[index];
      if (!item) {
        return;
      }
      if (item.type === 'report') {
        switchView('view-reporting');
        leftNavMode.value = 'reports';
        reportSearchInput.disabled = false;
        selectedReportingForm = item.key;
        filterAndRenderReportList();
        loadTable(selectedReportingForm);
        return;
      }
      if (item.url) {
        window.location.href = item.url;
      }
    }

    function updateDiscoveryMetaCounts() {
      if (!discoveryGridApi) {
        return;
      }
      const total = lastDiscoveryRows.length;
      const visible = discoveryGridApi.getDisplayedRowCount();
      setDiscoveryMeta(total === visible ? `${total} records found` : `${visible} of ${total} records shown`);
    }

    function pickRowValue(row, keys) {
      const byLower = {};
      Object.keys(row || {}).forEach(key => {
        byLower[key.toLowerCase()] = row[key];
      });
      for (const key of keys) {
        const value = byLower[key.toLowerCase()];
        if (value !== null && value !== undefined && String(value).trim() !== '') {
          return value;
        }
      }
      return '';
    }

    function buildDiscoveryRows(rows) {
      return rows.map(row => {
        const code = String(pickRowValue(row, ['mdrm_code', 'mdrm']) || '').trim();
        const descriptionRaw = String(pickRowValue(row, ['line_description', 'item_name', 'description', 'label']) || '').trim();
        const reportingForm = String(pickRowValue(row, ['reporting_form', 'report']) || '').trim();
        const rawType = String(pickRowValue(row, ['item_type', 'item_type_cd', 'itemtype', 'mdrm_type', 'type']) || '').trim();
        const typeCodeMap = {
          J: 'Projected',
          D: 'Derived',
          F: 'Financial/reported',
          R: 'Rate',
          S: 'Structure',
          E: 'Examination/supervision',
          P: 'Percentage'
        };
        const mdrmType = rawType.length === 1 && typeCodeMap[rawType.toUpperCase()]
          ? typeCodeMap[rawType.toUpperCase()]
          : rawType;
        return { code, descriptionRaw, reportingForm, mdrmType, bookmarked: false };
      });
    }

    function refreshDiscoveryBookmarkFlags() {
      const keySet = new Set(
        (bookmarkItems || [])
          .map(item => String(item.itemKey || '').trim().toLowerCase())
          .filter(Boolean)
      );
      lastDiscoveryRows = (lastDiscoveryRows || []).map(row => ({
        ...row,
        bookmarked: keySet.has(String(row.code || '').trim().toLowerCase())
      }));
      if (discoveryGridApi) {
        discoveryGridApi.setGridOption('rowData', lastDiscoveryRows);
      }
    }

    function buildBookmarkPayload(itemKey, title, subtitle, url, itemType = 'mdrm') {
      return {
        groupId: null,
        itemType,
        itemKey: String(itemKey || '').trim(),
        title: String(title || itemKey || 'Item').trim(),
        subtitle: String(subtitle || '').trim(),
        url: String(url || '').trim()
      };
    }

    function showSaveBookmarkModal(payload) {
      pendingBookmarkPayload = payload;
      if (saveBookmarkContext) {
        saveBookmarkContext.textContent = `${payload.itemKey}${payload.subtitle ? ` â€¢ ${payload.subtitle}` : ''}`;
      }
      if (saveBookmarkGroupSelect) {
        saveBookmarkGroupSelect.value = '';
      }
      if (saveBookmarkNewGroupInput) {
        saveBookmarkNewGroupInput.value = '';
      }
      if (saveBookmarkNewGroupWrap) {
        saveBookmarkNewGroupWrap.style.display = 'none';
      }
      if (!saveBookmarkModal && saveBookmarkModalEl && window.bootstrap) {
        saveBookmarkModal = new bootstrap.Modal(saveBookmarkModalEl);
      }
      if (saveBookmarkModal) {
        saveBookmarkModal.show();
      } else {
        savePendingBookmark();
      }
    }

    function applyDiscoveryGridTheme(theme) {
      if (!discoveryGrid) {
        return;
      }
      const dark = theme === 'dark';
      discoveryGrid.classList.toggle('ag-theme-quartz-dark', dark);
      discoveryGrid.classList.toggle('ag-theme-quartz', !dark);
    }

    function initDiscoveryGrid() {
      if (discoveryGridApi || !discoveryGrid || !window.agGrid) {
        return;
      }
      discoveryGridApi = agGrid.createGrid(discoveryGrid, {
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true,
          floatingFilter: false
        },
        pagination: true,
        paginationPageSize: 20,
        paginationPageSizeSelector: [20, 50, 100],
        suppressCellFocus: true,
        rowHeight: 30,
        headerHeight: 34,
        animateRows: true,
        tooltipShowDelay: 150,
        tooltipMouseTrack: true,
        onFilterChanged: () => updateDiscoveryMetaCounts(),
        onCellClicked: async params => {
          if (!params || !params.column || params.column.getColId() !== 'bookmarkAction') {
            return;
          }
          const row = params.data || {};
          const code = String(row.code || '').trim();
          if (!code) {
            return;
          }
          try {
            if (!currentUser) {
              setAuthStatus('Login required to save bookmarks.', 'err');
              if (profileMenu && profileMenuBtn) {
                profileMenu.classList.add('open');
                profileMenuBtn.setAttribute('aria-expanded', 'true');
              }
              return;
            }
            if (row.bookmarked) {
              await removeBookmarkByItemKey(code);
              return;
            }
            const subtitle = [row.descriptionRaw || '', row.reportingForm ? `Form ${row.reportingForm}` : '']
              .filter(Boolean)
              .join(' | ');
            showSaveBookmarkModal(buildBookmarkPayload(
              code,
              code,
              subtitle,
              `/mdrm.html?mdrm=${encodeURIComponent(code)}`
            ));
          } catch (error) {
            console.error('Bookmark action failed', error);
            setAuthStatus('Bookmark action failed. Please retry.', 'err');
          }
        },
        columnDefs: [
          {
            headerName: 'MDRM Code',
            field: 'code',
            minWidth: 145,
            maxWidth: 220,
            cellRenderer: params => {
              const value = String(params.value || '').trim();
              const reportingForm = String(params.data && params.data.reportingForm ? params.data.reportingForm : '').trim();
              return value
                ? `<a href="/mdrm.html?mdrm=${encodeURIComponent(value)}" data-reporting-form="${escapeHtml(reportingForm)}">${escapeHtml(value)}</a>`
                : '-';
            }
          },
          {
            headerName: 'Description',
            field: 'descriptionRaw',
            flex: 1.4,
            minWidth: 320,
            tooltipValueGetter: params => {
              const value = String(params.value || '');
              return value.length > 100 ? value : '';
            },
            valueFormatter: params => {
              const value = String(params.value || '');
              return value.length > 100 ? `${value.slice(0, 100)}...` : (value || '-');
            }
          },
          {
            headerName: 'Reporting Form',
            field: 'reportingForm',
            minWidth: 170,
            maxWidth: 240,
            valueFormatter: params => String(params.value || '-')
          },
          {
            headerName: 'MDRM Type',
            field: 'mdrmType',
            minWidth: 190,
            maxWidth: 260,
            valueFormatter: params => String(params.value || '-')
          },
          {
            headerName: 'Favorite',
            colId: 'bookmarkAction',
            field: 'bookmarked',
            minWidth: 92,
            maxWidth: 126,
            sortable: true,
            filter: false,
            resizable: false,
            cellStyle: { textAlign: 'center' },
            comparator: (valueA, valueB) => {
              const a = valueA ? 1 : 0;
              const b = valueB ? 1 : 0;
              return a - b;
            },
            cellRenderer: params => {
              const code = String(params.data && params.data.code ? params.data.code : '').trim();
              if (!code) {
                return '-';
              }
              const isBookmarked = !!(params.data && params.data.bookmarked);
              const description = String(params.data && params.data.descriptionRaw ? params.data.descriptionRaw : '').trim();
              const report = String(params.data && params.data.reportingForm ? params.data.reportingForm : '').trim();
              const subtitle = [description, report ? `Form ${report}` : ''].filter(Boolean).join(' | ');
              return `<button class="bookmark-star-btn bookmark-item-btn ${isBookmarked ? 'active' : ''}"
                        type="button"
                        title="${isBookmarked ? 'Bookmarked' : 'Save bookmark'}"
                        data-bookmarked="${isBookmarked ? 'true' : 'false'}"
                        data-item-type="mdrm"
                        data-item-key="${escapeHtml(code)}"
                        data-title="${escapeHtml(code)}"
                        data-subtitle="${escapeHtml(subtitle)}"
                        data-url="/mdrm.html?mdrm=${encodeURIComponent(code)}">${isBookmarked ? 'â˜…' : 'â˜†'}</button>`;
            }
          }
        ],
        rowData: []
      });
      applyDiscoveryGridTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');
      window.addEventListener('resize', () => {
        if (discoveryGridApi) {
          discoveryGridApi.sizeColumnsToFit();
        }
      });
    }

    function renderDiscoveryRows(rows) {
      initDiscoveryGrid();
      const codeFilter = (filterCodeInput.value || '').trim().toLowerCase();
      const descriptionFilter = (filterDescriptionInput.value || '').trim().toLowerCase();
      const reportingFormFilter = (filterReportingFormInput.value || '').trim().toLowerCase();
      const filteredRows = rows.filter(row => {
        if (codeFilter && !row.code.toLowerCase().includes(codeFilter)) {
          return false;
        }
        if (descriptionFilter && !row.descriptionRaw.toLowerCase().includes(descriptionFilter)) {
          return false;
        }
        if (reportingFormFilter && !row.reportingForm.toLowerCase().includes(reportingFormFilter)) {
          return false;
        }
        return true;
      });

      if (!rows.length) {
        if (discoveryGridApi) {
          discoveryGridApi.setGridOption('rowData', []);
        }
        setDiscoveryResultsVisible(true);
        if (discoveryGrid) {
          discoveryGrid.style.display = 'none';
        }
        setDiscoveryMeta('No records found');
        return;
      }

      if (!filteredRows.length) {
        if (discoveryGridApi) {
          discoveryGridApi.setGridOption('rowData', []);
        }
        setDiscoveryResultsVisible(true);
        if (discoveryGrid) {
          discoveryGrid.style.display = 'none';
        }
        setDiscoveryMeta('No records match current filters');
        return;
      }
      setDiscoveryResultsVisible(true);
      if (discoveryGrid) {
        discoveryGrid.style.display = 'block';
      }
      if (discoveryGridApi) {
        const firstPassRows = [...filteredRows].sort((a, b) => {
          const favDelta = Number(Boolean(b.bookmarked)) - Number(Boolean(a.bookmarked));
          if (favDelta !== 0) {
            return favDelta;
          }
          return String(a.code || '').localeCompare(String(b.code || ''), undefined, { sensitivity: 'base' });
        });
        discoveryGridApi.setGridOption('rowData', firstPassRows);
        setTimeout(() => discoveryGridApi && discoveryGridApi.sizeColumnsToFit(), 0);
        updateDiscoveryMetaCounts();
      }
    }

    function renderDiscoveryResults(payload) {
      const table = payload && payload.results ? payload.results : null;
      const rows = table && Array.isArray(table.rows) ? table.rows : [];
      lastDiscoveryRows = buildDiscoveryRows(rows);
      refreshDiscoveryBookmarkFlags();
      if (discoveryFiltersRow) {
        discoveryFiltersRow.style.display = 'none';
      }
      renderDiscoveryRows(lastDiscoveryRows);
    }

    function setAuthStatus(text, css) {
      authStatusLabel.textContent = text;
      authStatusLabel.className = `status ${css} mt-2`;
    }

    function renderBookmarkGroups() {
      if (!currentUser) {
        bookmarkGroupsContainer.innerHTML = '<div class="text-muted small p-2">Login to create groups.</div>';
        bookmarkFilterGroupSelect.innerHTML = '<option value="">Browse all groups</option>';
        if (saveBookmarkGroupSelect) {
          saveBookmarkGroupSelect.innerHTML = '<option value="">Default Favorites</option>';
        }
        return;
      }

      const selectedFilterGroup = bookmarkFilterGroupSelect.value;
      bookmarkFilterGroupSelect.innerHTML = `<option value="">Browse all groups</option>${bookmarkGroups.map(group =>
        `<option value="${group.groupId}">${escapeHtml(group.name)} (${group.itemCount})</option>`
      ).join('')}`;
      if (saveBookmarkGroupSelect) {
        const selectedSaveGroup = saveBookmarkGroupSelect.value;
        saveBookmarkGroupSelect.innerHTML = `<option value="">Default Favorites</option>${bookmarkGroups.map(group =>
          `<option value="${group.groupId}">${escapeHtml(group.name)}</option>`
        ).join('')}<option value="__new__">+ Create new group</option>`;
        if (selectedSaveGroup && saveBookmarkGroupSelect.querySelector(`option[value="${selectedSaveGroup}"]`)) {
          saveBookmarkGroupSelect.value = selectedSaveGroup;
        }
      }
      if (selectedFilterGroup) {
        bookmarkFilterGroupSelect.value = selectedFilterGroup;
      }

      if (!bookmarkGroups.length) {
        bookmarkGroupsContainer.innerHTML = '<div class="text-muted small p-2">No groups yet.</div>';
        return;
      }

      bookmarkGroupsContainer.innerHTML = `
        <div class="small fw-semibold mb-1">Groups</div>
        <div class="d-flex flex-wrap gap-2">
          ${bookmarkGroups.map(group => `<span class="tag">${escapeHtml(group.name)} (${group.itemCount})</span>`).join('')}
        </div>
      `;
    }

    function renderBookmarkItems() {
      if (!currentUser) {
        bookmarkItemsContainer.innerHTML = '<div class="text-muted small p-2">Login to browse bookmarks.</div>';
        return;
      }
      if (!bookmarkItems.length) {
        bookmarkItemsContainer.innerHTML = '<div class="text-muted small p-2">No bookmarks yet.</div>';
        return;
      }

      bookmarkItemsContainer.innerHTML = `
        <div class="small fw-semibold mb-1">Saved items</div>
        <div class="bookmark-list">
          ${bookmarkItems.map(item => `
            <div class="bookmark-item">
              <div class="bookmark-title">
                ${item.url ? `<a href="${escapeHtml(item.url)}">${escapeHtml(item.itemKey)}</a>` : escapeHtml(item.itemKey)}
              </div>
              <div class="bookmark-subtitle">${escapeHtml(item.title)}${item.groupName ? ` â€¢ ${escapeHtml(item.groupName)}` : ''}</div>
              <div class="d-flex gap-1 mt-1">
                <select class="form-select form-select-sm bookmark-move-group" data-bookmark-id="${item.bookmarkId}">
                  <option value="">No group</option>
                  ${bookmarkGroups.map(group => `
                    <option value="${group.groupId}" ${item.groupId === group.groupId ? 'selected' : ''}>${escapeHtml(group.name)}</option>
                  `).join('')}
                </select>
                <button class="btn btn-sm btn-outline-secondary move-bookmark-btn" type="button" data-bookmark-id="${item.bookmarkId}">Move</button>
              </div>
              <button class="btn btn-sm btn-outline-danger remove-bookmark-btn mt-1" type="button" data-bookmark-id="${item.bookmarkId}">Remove</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function syncAuthUi() {
      const isLoggedIn = !!currentUser;
      authLoginBtn.disabled = isLoggedIn;
      authRegisterBtn.disabled = isLoggedIn;
      authResetBtn.disabled = isLoggedIn;
      authLogoutBtn.disabled = !isLoggedIn;
      createGroupBtn.disabled = !isLoggedIn;
      bookmarkFilterGroupSelect.disabled = !isLoggedIn;
      bookmarkUserLabel.textContent = isLoggedIn ? `Logged in as ${currentUser.displayName}` : 'Login required';
      profileNameLabel.textContent = isLoggedIn ? currentUser.displayName : 'Guest';
      if (authInputRows && authLoginCol && authRegisterCol && authLogoutCol) {
        if (authModeRow) authModeRow.style.display = isLoggedIn ? 'none' : '';
        if (isLoggedIn) {
          if (authEmailCol) authEmailCol.style.display = 'none';
          if (authFirstNameCol) authFirstNameCol.style.display = 'none';
          if (authLastNameCol) authLastNameCol.style.display = 'none';
          if (authPasswordCol) authPasswordCol.style.display = 'none';
          if (authConfirmPasswordCol) authConfirmPasswordCol.style.display = 'none';
          if (authShowPasswordCol) authShowPasswordCol.style.display = 'none';
          authLoginCol.style.display = 'none';
          authRegisterCol.style.display = 'none';
          if (authResetCol) authResetCol.style.display = 'none';
        } else {
          setAuthMode(authMode);
        }
        authLogoutCol.style.display = '';
      }
      renderBookmarkGroups();
      renderBookmarkItems();
      renderRecentItems();
      renameGroupBtn.disabled = !isLoggedIn || !bookmarkFilterGroupSelect.value;
      deleteGroupBtn.disabled = !isLoggedIn || !bookmarkFilterGroupSelect.value;
    }

    async function refreshAuthState() {
      try {
        const response = await fetch('/api/auth/me');
        const payload = await response.json();
        currentUser = payload && payload.authenticated ? payload.user : null;
      } catch (error) {
        currentUser = null;
      }
      if (currentUser) {
        setAuthStatus(`Logged in as ${currentUser.displayName} (${currentUser.email})`, 'ok');
        await refreshBookmarks();
        await loadRecentItems();
      } else {
        setAuthStatus('Not logged in', 'neutral');
        bookmarkGroups = [];
        bookmarkItems = [];
        refreshDiscoveryBookmarkFlags();
        loadRecentItemsFromLocal();
        renderRecentItems();
      }
      syncAuthUi();
    }

    async function refreshBookmarks() {
      if (!currentUser) {
        return;
      }
      try {
        const filterGroupId = bookmarkFilterGroupSelect.value ? Number(bookmarkFilterGroupSelect.value) : null;
        const itemsUrl = filterGroupId ? `/api/bookmarks/items?groupId=${encodeURIComponent(filterGroupId)}` : '/api/bookmarks/items';
        const [groupsRes, itemsRes] = await Promise.all([
          fetch('/api/bookmarks/groups'),
          fetch(itemsUrl)
        ]);
        if (!groupsRes.ok || !itemsRes.ok) {
          throw new Error('Failed to load bookmarks');
        }
        bookmarkGroups = await groupsRes.json();
        bookmarkItems = await itemsRes.json();
      } catch (error) {
        bookmarkGroups = [];
        bookmarkItems = [];
      }
      refreshDiscoveryBookmarkFlags();
      syncAuthUi();
    }

    async function login() {
      const email = (authEmailInput.value || '').trim();
      const password = (authPasswordInput.value || '').trim();
      if (!email || !password) {
        setAuthStatus('Email and password are required.', 'err');
        return;
      }
      try {
        const response = await apiFetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        authPasswordInput.value = '';
        await refreshAuthState();
      } catch (error) {
        setAuthStatus('Login failed. Check credentials.', 'err');
      }
    }

    async function register() {
      const firstName = (authFirstNameInput.value || '').trim();
      const lastName = (authLastNameInput.value || '').trim();
      const email = (authEmailInput.value || '').trim();
      const password = (authPasswordInput.value || '').trim();
      const confirmPassword = (authConfirmPasswordInput.value || '').trim();
      if (!firstName || !lastName || !email || !password || !confirmPassword) {
        setAuthStatus('First name, last name, email and password are required.', 'err');
        return;
      }
      if (password !== confirmPassword) {
        setAuthStatus('Passwords do not match.', 'err');
        return;
      }
      try {
        const response = await apiFetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ firstName, lastName, email, password })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        authPasswordInput.value = '';
        authConfirmPasswordInput.value = '';
        await refreshAuthState();
      } catch (error) {
        setAuthStatus('Registration failed. Email may already exist.', 'err');
      }
    }

    async function resetPassword() {
      const email = (authEmailInput.value || '').trim();
      const newPassword = (authPasswordInput.value || '').trim();
      const confirmPassword = (authConfirmPasswordInput.value || '').trim();
      if (!email || !newPassword || !confirmPassword) {
        setAuthStatus('Email, new password and confirmation are required.', 'err');
        return;
      }
      if (newPassword !== confirmPassword) {
        setAuthStatus('Passwords do not match.', 'err');
        return;
      }
      try {
        const response = await apiFetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        authPasswordInput.value = '';
        authConfirmPasswordInput.value = '';
        setAuthMode('login');
        setAuthStatus('Password reset successful. Please login.', 'ok');
      } catch (error) {
        setAuthStatus('Password reset failed. Check email and try again.', 'err');
      }
    }

    async function logout() {
      try {
        await apiFetch('/api/auth/logout', { method: 'POST' });
      } catch (error) {
        // noop
      }
      currentUser = null;
      bookmarkGroups = [];
      bookmarkItems = [];
      authPasswordInput.value = '';
      authConfirmPasswordInput.value = '';
      if (authShowPasswordInput) {
        authShowPasswordInput.checked = false;
      }
      setPasswordVisibility(false);
      authMode = '';
      syncAuthUi();
      setAuthStatus('Logged out', 'neutral');
      loadRecentItemsFromLocal();
      renderRecentItems();
    }

    async function createGroup() {
      const name = (newGroupNameInput.value || '').trim();
      if (!name) {
        return;
      }
      await createGroupByName(name);
      newGroupNameInput.value = '';
    }

    async function createGroupByName(name) {
      const groupName = String(name || '').trim();
      if (!groupName) {
        return null;
      }
      try {
        const response = await apiFetch('/api/bookmarks/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: groupName })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        await refreshBookmarks();
        const created = bookmarkGroups.find(group => String(group.name || '').toLowerCase() === groupName.toLowerCase());
        return created ? Number(created.groupId) : null;
      } catch (error) {
        setAuthStatus('Could not create group.', 'err');
        return null;
      }
    }

    async function addBookmarkFromButton(button) {
      if (!currentUser) {
        setAuthStatus('Login required to save bookmarks.', 'err');
        return;
      }
      const payload = buildBookmarkPayload(
        button.dataset.itemKey || '',
        button.dataset.title || button.dataset.itemKey || 'Item',
        button.dataset.subtitle || '',
        button.dataset.url || '',
        button.dataset.itemType || 'mdrm'
      );
      if (!payload.itemKey) {
        return;
      }
      showSaveBookmarkModal(payload);
    }

    async function savePendingBookmark() {
      if (!pendingBookmarkPayload) {
        return;
      }
      let targetGroupId = null;
      if (saveBookmarkGroupSelect) {
        const selected = saveBookmarkGroupSelect.value;
        if (selected === '__new__') {
          const groupName = (saveBookmarkNewGroupInput.value || '').trim();
          if (!groupName) {
            setAuthStatus('Enter a group name to create and save.', 'err');
            return;
          }
          const createdGroupId = await createGroupByName(groupName);
          if (!createdGroupId) {
            return;
          }
          targetGroupId = createdGroupId;
        } else if (selected) {
          targetGroupId = Number(selected);
        }
      }

      const payload = { ...pendingBookmarkPayload, groupId: Number.isNaN(targetGroupId) ? null : targetGroupId };
      try {
        const response = await apiFetch('/api/bookmarks/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        await refreshBookmarks();
        setAuthStatus('Bookmark saved.', 'ok');
        if (saveBookmarkModal) {
          saveBookmarkModal.hide();
        }
        pendingBookmarkPayload = null;
      } catch (error) {
        setAuthStatus('Could not save bookmark. It may already exist.', 'err');
      }
    }

    async function removeBookmark(bookmarkId) {
      if (!currentUser) {
        return;
      }
      try {
        const response = await apiFetch(`/api/bookmarks/items/${bookmarkId}`, { method: 'DELETE' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        await refreshBookmarks();
      } catch (error) {
        setAuthStatus('Could not remove bookmark.', 'err');
      }
    }

    async function removeBookmarkByItemKey(itemKey) {
      const key = String(itemKey || '').trim().toLowerCase();
      if (!key || !currentUser) {
        return;
      }
      const existing = (bookmarkItems || []).find(item => String(item.itemKey || '').trim().toLowerCase() === key);
      if (!existing || !existing.bookmarkId) {
        return;
      }
      await removeBookmark(Number(existing.bookmarkId));
    }

    async function renameSelectedGroup() {
      const groupId = bookmarkFilterGroupSelect.value ? Number(bookmarkFilterGroupSelect.value) : null;
      const name = (renameGroupNameInput.value || '').trim();
      if (!groupId || !name) {
        return;
      }
      try {
        const response = await apiFetch(`/api/bookmarks/groups/${groupId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        renameGroupNameInput.value = '';
        await refreshBookmarks();
      } catch (error) {
        setAuthStatus('Could not rename group.', 'err');
      }
    }

    async function deleteSelectedGroup() {
      const groupId = bookmarkFilterGroupSelect.value ? Number(bookmarkFilterGroupSelect.value) : null;
      if (!groupId) {
        return;
      }
      try {
        const response = await apiFetch(`/api/bookmarks/groups/${groupId}`, { method: 'DELETE' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        bookmarkFilterGroupSelect.value = '';
        await refreshBookmarks();
      } catch (error) {
        setAuthStatus('Could not delete group.', 'err');
      }
    }

    async function moveBookmark(bookmarkId, groupId) {
      try {
        const response = await apiFetch(`/api/bookmarks/items/${bookmarkId}/group`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId })
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        await refreshBookmarks();
      } catch (error) {
        setAuthStatus('Could not move bookmark.', 'err');
      }
    }

    async function runDiscoverySearch() {
      const query = (discoveryQueryInput.value || '').trim();
      if (!query) {
        setDiscoveryResultsVisible(false);
        return;
      }
      discoverySearchBtn.disabled = true;
      setDiscoveryResultsVisible(true);
      setDiscoveryMeta('Searching...');
      if (discoveryQuickFilterInput) {
        discoveryQuickFilterInput.value = '';
      }
      if (discoveryGridApi) {
        discoveryGridApi.setGridOption('quickFilterText', '');
        discoveryGridApi.setGridOption('rowData', []);
      }
      if (discoveryGrid) {
        discoveryGrid.style.display = 'none';
      }
      try {
        const response = await fetch(`/api/mdrm/semantic-search?q=${encodeURIComponent(query)}`);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        renderDiscoveryResults(payload);
      } catch (error) {
        setDiscoveryMeta(`Search failed: ${error.message}`);
      } finally {
        discoverySearchBtn.disabled = false;
      }
    }

    function renderTable(payload) {
      if (!payload || !payload.columns || !payload.rows) {
        tableContainer.innerHTML = '';
        return;
      }
      const headerHtml = payload.columns.map(c => `<th>${escapeHtml(c)}</th>`).join('');
      const rowsHtml = payload.rows.map(row => {
        const cells = payload.columns.map(c => `<td>${escapeHtml(row[c])}</td>`).join('');
        return `<tr>${cells}</tr>`;
      }).join('');
      tableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead><tr>${headerHtml}</tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function formatRunDate(epochMillis) {
      if (!epochMillis) {
        return '';
      }
      const value = Number(epochMillis);
      if (Number.isNaN(value)) {
        return '';
      }
      return new Date(value).toLocaleString();
    }

    function renderRunHistory(payload) {
      const runs = payload && payload.runs ? payload.runs : [];
      if (!runs.length) {
        summaryTableContainer.innerHTML = '';
        return;
      }
      const rowsHtml = runs.map(run => `
        <tr>
          <td>${escapeHtml(run.runId)}</td>
          <td>${escapeHtml(formatRunDate(run.runDatetime))}</td>
          <td>${escapeHtml(run.fileName)}</td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="TOTAL">${escapeHtml(run.totalUniqueMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="ACTIVE">${escapeHtml(run.activeMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="INACTIVE">${escapeHtml(run.inactiveMdrms)}</a></td>
          <td><a class="count-link" href="#" data-run-id="${escapeHtml(run.runId)}" data-bucket="UPDATED">${escapeHtml(run.updatedMdrms)}</a></td>
          <td>${escapeHtml(run.addedMdrms ?? 0)}</td>
          <td>${escapeHtml(run.modifiedMdrms ?? 0)}</td>
          <td>${escapeHtml(run.deletedMdrms ?? 0)}</td>
        </tr>
      `).join('');
      summaryTableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Run Date</th>
              <th>Source File</th>
              <th>Total Unique MDRMs</th>
              <th>Active</th>
              <th>Inactive</th>
              <th>Updated</th>
              <th>Added</th>
              <th>Modified</th>
              <th>Deleted</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderDrilldown(payload) {
      const codes = payload && payload.mdrmCodes ? payload.mdrmCodes : [];
      drilldownTitle.textContent = `Run ${payload.runId} | ${payload.bucket} MDRMs: ${codes.length}`;
      drilldownTitle.className = 'status ok';
      if (!codes.length) {
        drilldownTableContainer.innerHTML = '';
        return;
      }
      const rowsHtml = codes.map(code => `
        <tr>
          <td><a href="/mdrm.html?mdrm=${encodeURIComponent(code)}">${escapeHtml(code)}</a></td>
        </tr>
      `).join('');
      drilldownTableContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead><tr><th>MDRM Code</th></tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderFileMetrics(runs) {
      if (!runs || !runs.length) {
        fileMetricsContainer.innerHTML = '';
        return;
      }
      const rowsHtml = runs.map(run => `
        <tr>
          <td>${escapeHtml(run.runId)}</td>
          <td>${escapeHtml(formatRunDate(run.runDatetime))}</td>
          <td>${escapeHtml(run.fileName)}</td>
          <td>${escapeHtml(run.numFileRecords)}</td>
          <td>${escapeHtml(run.numRecordsIngested)}</td>
          <td>${escapeHtml(run.numRecordsError)}</td>
          <td>${escapeHtml(run.reportsCount)}</td>
          <td>${escapeHtml(run.totalUniqueMdrms)}</td>
          <td>${escapeHtml(run.activeMdrms)}</td>
          <td>${escapeHtml(run.inactiveMdrms)}</td>
          <td>${escapeHtml(run.updatedMdrms)}</td>
          <td><a class="file-inc-link" href="#" data-run-id="${escapeHtml(run.runId)}">View</a></td>
        </tr>
      `).join('');

      fileMetricsContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Run Date</th>
              <th>Source File</th>
              <th>File Rows</th>
              <th>Ingested</th>
              <th>Error</th>
              <th>Reports</th>
              <th>Total MDRMs</th>
              <th>Active</th>
              <th>Inactive</th>
              <th>Updated</th>
              <th>Incremental</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderFileIncremental(runId, rows) {
      fileIncrementalTitle.textContent = `Run ${runId} incremental changes by report`;
      fileIncrementalTitle.className = 'status ok mt-2';
      if (!rows || !rows.length) {
        fileIncrementalContainer.innerHTML = '<div class="text-muted small p-2">No incremental changes for this run.</div>';
        fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
        return;
      }
      const body = rows.map(row => `
        <tr>
          <td>${escapeHtml(row.reportingForm)}</td>
          <td>${escapeHtml(row.addedMdrms)}</td>
          <td>${escapeHtml(row.modifiedMdrms)}</td>
          <td>${escapeHtml(row.deletedMdrms)}</td>
          <td><a class="inc-report-link" href="#" data-run-id="${escapeHtml(runId)}" data-reporting-form="${escapeHtml(row.reportingForm)}">Details</a></td>
        </tr>
      `).join('');
      fileIncrementalContainer.innerHTML = `
        <table class="table table-sm table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Reporting Form</th>
              <th>Added</th>
              <th>Modified</th>
              <th>Deleted</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
      `;
      fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
    }

    function renderIncrementalDetailPanel(runId, reportingForm, addedCodes, modifiedCodes, deletedCodes) {
      const sectionIdPrefix = `inc-${runId}-${reportingForm.replaceAll(/[^a-zA-Z0-9]/g, '_')}`;
      const buildRows = codes => {
        if (!codes.length) {
          return '<div class="text-muted small">No MDRMs</div>';
        }
        return `<div class="small" style="max-height: 220px; overflow: auto;"><ul class="mb-0">${codes.map(code => `<li><a href="/mdrm.html?mdrm=${encodeURIComponent(code)}">${escapeHtml(code)}</a></li>`).join('')}</ul></div>`;
      };

      fileIncrementalDetailPanel.innerHTML = `
        <div class="p-2">
          <div class="fw-semibold mb-2">Run ${escapeHtml(runId)} | ${escapeHtml(reportingForm)}</div>
          <div class="accordion" id="${sectionIdPrefix}-accordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-added" aria-expanded="true">
                  Added MDRMs (${addedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-added" class="accordion-collapse collapse show" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(addedCodes)}</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-modified" aria-expanded="false">
                  Modified MDRMs (${modifiedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-modified" class="accordion-collapse collapse" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(modifiedCodes)}</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionIdPrefix}-deleted" aria-expanded="false">
                  Deleted MDRMs (${deletedCodes.length})
                </button>
              </h2>
              <div id="${sectionIdPrefix}-deleted" class="accordion-collapse collapse" data-bs-parent="#${sectionIdPrefix}-accordion">
                <div class="accordion-body">${buildRows(deletedCodes)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function switchReportTab(targetTabId) {
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetTabId));
      tabButtons.forEach(button => {
        const active = button.dataset.tab === targetTabId;
        button.classList.toggle('active', active);
        button.setAttribute('aria-selected', String(active));
      });
    }

    async function runLoad() {
      setLoadActionsDisabled(true);
      setLoadStatus('Loading... calling /api/mdrm/load', 'neutral');
      try {
        const response = await apiFetch('/api/mdrm/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const bodyText = await response.text();
        let payload;
        try {
          payload = bodyText ? JSON.parse(bodyText) : null;
        } catch {
          payload = bodyText;
        }
        if (!response.ok) {
          setLoadStatus(
            `Load failed (HTTP ${response.status})\n${typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2)}`,
            'err'
          );
          return;
        }
        setLoadStatus(`Load successful\n${JSON.stringify(payload, null, 2)}`, 'ok');
        formsLoaded = false;
        await refreshFileMetrics();
      } catch (error) {
        setLoadStatus(`Request error\n${error.message}`, 'err');
      } finally {
        setLoadActionsDisabled(false);
      }
    }

    async function uploadFile() {
      const file = uploadFileInput.files && uploadFileInput.files[0];
      if (!file) {
        setLoadStatus('Select an MDRM_ddyy.csv file first.', 'err');
        return;
      }
      const form = new FormData();
      form.append('file', file);

      setLoadActionsDisabled(true);
      setLoadStatus(`Uploading ${file.name}...`, 'neutral');
      try {
        const response = await apiFetch('/api/mdrm/upload', {
          method: 'POST',
          body: form
        });
        const bodyText = await response.text();
        let payload;
        try {
          payload = bodyText ? JSON.parse(bodyText) : null;
        } catch {
          payload = bodyText;
        }
        if (!response.ok) {
          setLoadStatus(
            `Upload failed (HTTP ${response.status})\n${typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2)}`,
            'err'
          );
          return;
        }
        setLoadStatus(`Upload successful\n${JSON.stringify(payload, null, 2)}`, 'ok');
        formsLoaded = false;
        uploadFileInput.value = '';
        updateLoadButtonStates();
        await refreshFileMetrics();
      } catch (error) {
        setLoadStatus(`Upload error\n${error.message}`, 'err');
      } finally {
        setLoadActionsDisabled(false);
      }
    }

    async function refreshFileMetrics() {
      try {
        const response = await fetch('/api/mdrm/file-runs');
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        const runs = Array.isArray(payload) ? payload : [];
        renderFileMetrics(runs);
        if (kpiMdrmCount) {
          if (!runs.length) {
            kpiMdrmCount.textContent = formatCount(0);
          } else {
            const latestRun = runs.reduce((latest, run) => {
              if (!latest) return run;
              return Number(run.runDatetime || 0) > Number(latest.runDatetime || 0) ? run : latest;
            }, null);
            kpiMdrmCount.textContent = formatCount((latestRun && latestRun.totalUniqueMdrms) ?? 0);
          }
        }
      } catch (error) {
        fileMetricsContainer.innerHTML = '<div class="text-danger small p-2">Failed to load file metrics.</div>';
        if (kpiMdrmCount) {
          kpiMdrmCount.textContent = formatCount(0);
        }
      }
    }

    async function loadFileIncremental(runId) {
      fileIncrementalTitle.textContent = `Loading incremental changes for run ${runId}...`;
      fileIncrementalTitle.className = 'status neutral mt-2';
      fileIncrementalContainer.innerHTML = '';
      fileIncrementalDetailPanel.innerHTML = '<div class="text-muted small p-2">Select a report row to view MDRM details.</div>';
      try {
        const response = await fetch(`/api/mdrm/incremental-summary?runId=${encodeURIComponent(runId)}`);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        renderFileIncremental(runId, Array.isArray(payload) ? payload : []);
      } catch (error) {
        fileIncrementalTitle.textContent = `Failed to load incremental changes for run ${runId}`;
        fileIncrementalTitle.className = 'status err mt-2';
      }
    }

    async function loadIncrementalReportDetails(runId, reportingForm) {
      fileIncrementalDetailPanel.innerHTML = `<div class="text-muted small p-2">Loading details for ${escapeHtml(reportingForm)}...</div>`;
      const queryForm = encodeURIComponent(reportingForm);
      const queryRun = encodeURIComponent(runId);
      try {
        const [addedRes, modifiedRes, deletedRes] = await Promise.all([
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=ADDED`),
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=MODIFIED`),
          fetch(`/api/mdrm/run-incremental-mdrms?reportingForm=${queryForm}&runId=${queryRun}&changeType=DELETED`)
        ]);
        const [addedPayload, modifiedPayload, deletedPayload] = await Promise.all([
          addedRes.json(),
          modifiedRes.json(),
          deletedRes.json()
        ]);
        if (!addedRes.ok || !modifiedRes.ok || !deletedRes.ok) {
          throw new Error('Failed to load one or more incremental MDRM lists');
        }
        renderIncrementalDetailPanel(
          runId,
          reportingForm,
          Array.isArray(addedPayload.mdrmCodes) ? addedPayload.mdrmCodes : [],
          Array.isArray(modifiedPayload.mdrmCodes) ? modifiedPayload.mdrmCodes : [],
          Array.isArray(deletedPayload.mdrmCodes) ? deletedPayload.mdrmCodes : []
        );
      } catch (error) {
        fileIncrementalDetailPanel.innerHTML = `<div class="text-danger small p-2">Failed to load details for ${escapeHtml(reportingForm)}.</div>`;
      }
    }

    async function refreshForms() {
      setReportingBusy(true);
      try {
        const response = await fetch('/api/mdrm/reporting-forms');
        const forms = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(forms)}`);
        }
        allForms = Array.isArray(forms) ? forms : [];
        formsLoaded = true;
        if (kpiReportCount) {
          kpiReportCount.textContent = formatCount(allForms.length);
        }
        const reportOption = leftNavMode.querySelector('option[value="reports"]');
        if (reportOption) {
          reportOption.textContent = `Reports (${allForms.length})`;
        }
        filterAndRenderReportList();
      } catch (error) {
        console.error('Failed to load report list', error);
      } finally {
        setReportingBusy(false);
      }
    }

    async function loadTable(reportingForm) {
      if (!reportingForm) {
        return;
      }
      recordRecentItem({
        type: 'report',
        key: reportingForm,
        label: reportingForm,
        subtitle: 'Reporting form',
        url: '/index.html'
      });
      setReportingBusy(true);
      selectedReportLabel.textContent = `Selected Report: ${reportingForm}`;
      clearReportData();
      try {
        const query = encodeURIComponent(reportingForm);
        const [historyResponse, detailsResponse] = await Promise.all([
          fetch(`/api/mdrm/run-history?reportingForm=${query}`),
          fetch(`/api/mdrm/data?reportingForm=${query}`)
        ]);
        const historyPayload = await historyResponse.json();
        const detailsPayload = await detailsResponse.json();
        if (!historyResponse.ok) {
          throw new Error(`Run history HTTP ${historyResponse.status}: ${JSON.stringify(historyPayload)}`);
        }
        if (!detailsResponse.ok) {
          throw new Error(`Details HTTP ${detailsResponse.status}: ${JSON.stringify(detailsPayload)}`);
        }
        renderRunHistory(historyPayload);
        renderTable(detailsPayload);
      } catch (error) {
        summaryTableContainer.innerHTML = '';
        tableContainer.innerHTML = '';
        console.error('Failed to load report data', error);
      } finally {
        setReportingBusy(false);
      }
    }

    runLoadBtn.addEventListener('click', runLoad);
    uploadFileBtn.addEventListener('click', uploadFile);
    uploadFileInput.addEventListener('change', updateLoadButtonStates);

    reportSearchInput.addEventListener('input', filterAndRenderReportList);

    leftNavMode.addEventListener('change', () => {
      if (leftNavMode.value === 'mdrms') {
        reportSearchInput.disabled = true;
        selectedReportLabel.textContent = 'Selected Report: -';
        selectedReportingForm = '';
        clearReportData();
      } else {
        reportSearchInput.disabled = false;
      }
      filterAndRenderReportList();
    });

    tabButtons.forEach(button => {
      button.addEventListener('click', event => {
        event.preventDefault();
        switchReportTab(button.dataset.tab);
      });
    });

    reportListContainer.addEventListener('click', event => {
      if (leftNavMode.value !== 'reports') {
        return;
      }
      const button = event.target.closest('.report-item');
      if (!button) {
        return;
      }
      selectedReportingForm = button.dataset.report || '';
      filterAndRenderReportList();
      loadTable(selectedReportingForm);
    });

    summaryTableContainer.addEventListener('click', async event => {
      if (leftNavMode.value !== 'reports') {
        return;
      }
      const link = event.target.closest('.count-link');
      if (!link || !selectedReportingForm) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      const bucket = link.dataset.bucket;
      const query = encodeURIComponent(selectedReportingForm);
      drilldownTitle.textContent = `Loading ${bucket} MDRM codes for run ${runId}...`;
      drilldownTitle.className = 'status neutral';
      drilldownTableContainer.innerHTML = '';
      try {
        const response = await fetch(`/api/mdrm/run-mdrms?reportingForm=${query}&runId=${encodeURIComponent(runId)}&bucket=${encodeURIComponent(bucket)}`);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${JSON.stringify(payload)}`);
        }
        renderDrilldown(payload);
      } catch (error) {
        drilldownTitle.textContent = `Failed to load MDRM drilldown\n${error.message}`;
        drilldownTitle.className = 'status err';
      }
    });

    fileMetricsContainer.addEventListener('click', event => {
      const link = event.target.closest('.file-inc-link');
      if (!link) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      if (!runId) {
        return;
      }
      loadFileIncremental(runId);
    });

    fileIncrementalContainer.addEventListener('click', event => {
      const link = event.target.closest('.inc-report-link');
      if (!link) {
        return;
      }
      event.preventDefault();
      const runId = link.dataset.runId;
      const reportingForm = link.dataset.reportingForm;
      if (!runId || !reportingForm) {
        return;
      }
      loadIncrementalReportDetails(runId, reportingForm);
    });

    discoverySearchBtn.addEventListener('click', runDiscoverySearch);
    [filterCodeInput, filterDescriptionInput, filterReportingFormInput].forEach(input => {
      input.addEventListener('input', () => renderDiscoveryRows(lastDiscoveryRows));
    });
    if (discoveryQuickFilterInput) {
      discoveryQuickFilterInput.addEventListener('input', () => {
        if (discoveryGridApi) {
          discoveryGridApi.setGridOption('quickFilterText', discoveryQuickFilterInput.value || '');
          updateDiscoveryMetaCounts();
        }
      });
    }
    discoveryQueryInput.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        event.preventDefault();
        runDiscoverySearch();
      }
    });

    authLoginBtn.addEventListener('click', login);
    authRegisterBtn.addEventListener('click', register);
    authResetBtn.addEventListener('click', resetPassword);
    authLogoutBtn.addEventListener('click', logout);
    if (authModeLoginBtn) {
      authModeLoginBtn.addEventListener('click', () => setAuthMode('login'));
    }
    if (authModeRegisterBtn) {
      authModeRegisterBtn.addEventListener('click', () => setAuthMode('register'));
    }
    if (authModeResetBtn) {
      authModeResetBtn.addEventListener('click', () => setAuthMode('reset'));
    }
    if (authShowPasswordInput) {
      authShowPasswordInput.addEventListener('change', () => setPasswordVisibility(authShowPasswordInput.checked));
    }
    createGroupBtn.addEventListener('click', createGroup);
    renameGroupBtn.addEventListener('click', renameSelectedGroup);
    deleteGroupBtn.addEventListener('click', deleteSelectedGroup);
    bookmarkFilterGroupSelect.addEventListener('change', async () => {
      renameGroupBtn.disabled = !currentUser || !bookmarkFilterGroupSelect.value;
      deleteGroupBtn.disabled = !currentUser || !bookmarkFilterGroupSelect.value;
      await refreshBookmarks();
    });
    if (saveBookmarkGroupSelect) {
      saveBookmarkGroupSelect.addEventListener('change', () => {
        const createNew = saveBookmarkGroupSelect.value === '__new__';
        if (saveBookmarkNewGroupWrap) {
          saveBookmarkNewGroupWrap.style.display = createNew ? '' : 'none';
        }
        if (!createNew && saveBookmarkNewGroupInput) {
          saveBookmarkNewGroupInput.value = '';
        }
      });
    }
    if (saveBookmarkConfirmBtn) {
      saveBookmarkConfirmBtn.addEventListener('click', savePendingBookmark);
    }
    if (saveBookmarkModalEl) {
      saveBookmarkModalEl.addEventListener('hidden.bs.modal', () => {
        pendingBookmarkPayload = null;
        if (saveBookmarkGroupSelect) {
          saveBookmarkGroupSelect.value = '';
        }
        if (saveBookmarkNewGroupInput) {
          saveBookmarkNewGroupInput.value = '';
        }
        if (saveBookmarkNewGroupWrap) {
          saveBookmarkNewGroupWrap.style.display = 'none';
        }
      });
    }

    if (clearRecentItemsBtn) {
      clearRecentItemsBtn.addEventListener('click', async () => {
        recentItems = [];
        saveRecentItems();
        renderRecentItems();
        if (currentUser) {
          try {
            const response = await apiFetch('/api/recent/items', { method: 'DELETE' });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            // Keep UI cleared even if server sync fails.
            setAuthStatus('Recent items cleared locally, but server sync failed.', 'err');
          }
        }
      });
    }
    if (recentItemsContainer) {
      recentItemsContainer.addEventListener('click', event => {
        const card = event.target.closest('.recent-item-card');
        if (!card) {
          return;
        }
        if (event.target.closest('.recent-bookmark-btn')) {
          return;
        }
        const index = Number(card.dataset.recentIndex);
        if (!Number.isNaN(index)) {
          openRecentItem(index);
        }
      });
      recentItemsContainer.addEventListener('keydown', event => {
        const card = event.target.closest('.recent-item-card');
        if (!card) {
          return;
        }
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          const index = Number(card.dataset.recentIndex);
          if (!Number.isNaN(index)) {
            openRecentItem(index);
          }
        }
      });
      recentItemsContainer.addEventListener('click', async event => {
        const starBtn = event.target.closest('.recent-bookmark-btn');
        if (!starBtn) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
        const index = Number(starBtn.dataset.recentBookmarkIndex);
        if (Number.isNaN(index)) {
          return;
        }
        try {
          await toggleRecentItemBookmark(index);
        } catch (error) {
          setAuthStatus('Could not update bookmark.', 'err');
        }
      });
    }

    discoverySearchResults.addEventListener('click', event => {
      const button = event.target.closest('.bookmark-item-btn');
      if (!button) {
        const mdrmLink = event.target.closest('a[href*=\"/mdrm.html?mdrm=\"]');
        if (mdrmLink) {
          try {
            const url = new URL(mdrmLink.getAttribute('href'), window.location.origin);
            const mdrm = url.searchParams.get('mdrm');
            const reportingForm = String(mdrmLink.dataset.reportingForm || selectedReportingForm || '').trim();
            if (mdrm) {
              recordRecentItem({
                type: 'mdrm',
                key: mdrm,
                label: mdrm,
                subtitle: reportingForm ? `Reporting form: ${reportingForm}` : '',
                url: `/mdrm.html?mdrm=${encodeURIComponent(mdrm)}`
              });
            }
          } catch (error) {
            // noop
          }
        }
        return;
      }
      event.preventDefault();
    });

    document.addEventListener('click', event => {
      const mdrmLink = event.target.closest('a[href*=\"/mdrm.html?mdrm=\"]');
      if (!mdrmLink) {
        return;
      }
      try {
        const url = new URL(mdrmLink.getAttribute('href'), window.location.origin);
        const mdrm = url.searchParams.get('mdrm');
        const reportingForm = String(mdrmLink.dataset.reportingForm || selectedReportingForm || '').trim();
        if (mdrm) {
          recordRecentItem({
            type: 'mdrm',
            key: mdrm,
            label: mdrm,
            subtitle: reportingForm ? `Reporting form: ${reportingForm}` : '',
            url: `/mdrm.html?mdrm=${encodeURIComponent(mdrm)}`
          });
        }
      } catch (error) {
        // noop
      }
    });

    bookmarkItemsContainer.addEventListener('click', event => {
      const button = event.target.closest('.remove-bookmark-btn');
      if (!button) {
        return;
      }
      const bookmarkId = Number(button.dataset.bookmarkId);
      if (!Number.isNaN(bookmarkId)) {
        removeBookmark(bookmarkId);
      }
    });
    bookmarkItemsContainer.addEventListener('click', event => {
      const button = event.target.closest('.move-bookmark-btn');
      if (!button) {
        return;
      }
      const bookmarkId = Number(button.dataset.bookmarkId);
      const select = bookmarkItemsContainer.querySelector(`.bookmark-move-group[data-bookmark-id="${bookmarkId}"]`);
      if (!Number.isNaN(bookmarkId) && select) {
        const groupId = select.value ? Number(select.value) : null;
        moveBookmark(bookmarkId, Number.isNaN(groupId) ? null : groupId);
      }
    });

    if (profileMenuBtn && profileMenu) {
      profileMenuBtn.addEventListener('click', () => {
        const isOpen = profileMenu.classList.toggle('open');
        profileMenuBtn.setAttribute('aria-expanded', String(isOpen));
      });
      document.addEventListener('click', event => {
        if (!event.target.closest('.profile-wrap')) {
          closeProfileMenu();
        }
      });
    }

    if (themeIconBtn) {
      themeIconBtn.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
      });
    }

    initTheme();
    ensureCsrfToken().catch(() => {});
    setPasswordVisibility(false);
    setAuthMode('');
    loadRecentItems();
    refreshAuthState();
    refreshForms();
    refreshFileMetrics();
    updateLoadButtonStates();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
